'use client'

import React, { useState, useEffect } from 'react';
import {
  LayoutDashboard,
  Database,
  BarChart3,
  DollarSign,
  Settings,
  User,
  Plus,
  RefreshCw,
  Search,
  ChevronDown,
  TrendingUp,
  Activity,
  Zap,
  Moon,
  Sun,
  Folder,
  Upload,
  File,
  X,
  Grid,
  List,
  ArrowLeft,
  Calendar,
  FileText,
  Video,
  Music,
  Archive,
  Code,
  Eye,
  Download,
  Trash2,
  Tag,
  Github,
  Twitter,
  Linkedin,
  Mail,
  Loader,
  ExternalLink,
  Image
} from 'lucide-react';

import { LineChart, Line, XAxis, YAxis, ResponsiveContainer, Tooltip } from 'recharts';
import { addDoc, getDocs, collection, doc, setDoc, deleteDoc, query, where, getDoc, updateDoc } from 'firebase/firestore';
import type { QuerySnapshot } from 'firebase/firestore';
import { getApps } from 'firebase/app';
import { db, storage, auth } from '@/lib/firebase';
import { ref, uploadBytes, getDownloadURL, deleteObject } from 'firebase/storage';
import { signInWithPopup, GoogleAuthProvider, GithubAuthProvider, onAuthStateChanged, User as FirebaseUser, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from 'firebase/auth';
import RepositoryList from './RepositoryList';
import AnnotationDashboard from './AnnotationDashboard';
import AddDataSourceModal from './AddDataSourceModal';
import LicenseSelectionModal from './LicenseSelectionModal';
import { Dataset, SourceType, LicenseType } from '@/lib/types';
import { uploadDataset, getDatasets } from '@/lib/datasetService';

interface Theme {
  bg: string;
  cardBg: string;
  text: string;
  textSecondary: string;
  border: string;
  borderLight: string;
  searchBg: string;
  sidebarBg: string;
  activityBg: string;
}

interface WalletFile {
  id: string;
  name: string;
  type: string;
  size: number;
  uploadDate: string;
  folder: string;
  thumbnail?: string;      
  downloadURL?: string;
  storagePath?: string;
}

interface WalletFolder {
  name: string;
  fileCount: number;
  totalSize: number;
  lastModified: string;
}

// Data Wallet Component
const DataWallet: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  isDarkMode: boolean;
  initialFolder?: string | null;
  uploadedFiles?: WalletFile[];
  userId?: string;
}> = ({ isOpen, onClose, isDarkMode, initialFolder, uploadedFiles = [], userId }) => {
  console.log('ðŸ“¥ DataWallet Props:');
  console.log('   - isOpen:', isOpen);
  console.log('   - initialFolder:', initialFolder);
  console.log('   - uploadedFiles.length:', uploadedFiles?.length);
  console.log('   - userId:', userId);
  
  const [currentFolder, setCurrentFolder] = useState<string | null>(initialFolder || null);
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedFilter, setSelectedFilter] = useState('all');
  const [folders, setFolders] = useState<WalletFolder[]>([]);
  const [files, setFiles] = useState<WalletFile[]>([]);
  const [showCreateFolderModal, setShowCreateFolderModal] = useState(false);
  const [newFolderName, setNewFolderName] = useState('');

  const theme = {
    light: {
      bg: '#f8fafc',
      cardBg: 'white',
      text: '#1e293b',
      textSecondary: '#64748b',
      border: '#e5e7eb',
      borderLight: '#f1f5f9',
      searchBg: '#f8fafc',
      hover: '#e0e7ff'
    },
    dark: {
      bg: '#0f172a',
      cardBg: '#1e293b',
      text: '#f1f5f9',
      textSecondary: '#94a3b8',
      border: '#334155',
      borderLight: '#475569',
      searchBg: '#334155',
      hover: '#312e81'
    }
  };

  const currentTheme = isDarkMode ? theme.dark : theme.light;

  useEffect(() => {
    // Fetch data from both Firebase and local state
    const fetchWalletData = async () => {
      try {
        console.log('ðŸ” Fetching wallet data...');
        console.log('ðŸ“¥ uploadedFiles prop received:', uploadedFiles?.length || 0, 'files');
        console.log('ðŸ‘¤ userId prop received:', userId);
        
        // Get local uploaded files from parent component
        const localFiles = uploadedFiles || [];
        console.log('ðŸ“ Local files found:', localFiles.length);
        
        // Group local files by folder
        const localFolders: { [key: string]: WalletFile[] } = {};
        localFiles.forEach(file => {
          if (!localFolders[file.folder]) {
            localFolders[file.folder] = [];
          }
          localFolders[file.folder].push(file);
        });
        
        // Create folder data from local files
        const localFoldersData: WalletFolder[] = Object.entries(localFolders).map(([folderName, files]) => ({
          name: folderName,
          fileCount: files.length,
          totalSize: files.reduce((acc, file) => acc + file.size, 0),
          lastModified: files.reduce((latest, file) => 
            file.uploadDate > latest ? file.uploadDate : latest, files[0].uploadDate)
        }));
        
        console.log('ðŸ“‚ Local folders created:', localFoldersData);
        
        // Fetch data from Firestore
        let firebaseFolders: WalletFolder[] = [];
        let firebaseFiles: WalletFile[] = [];
        
        // Get userId from prop or use demo-user as fallback
        const walletUserId = userId || 'demo-user';
        console.log(`ðŸ” DataWallet props:`, { userId, walletUserId, isValid: !!userId });
        
        // Only fetch from Firestore if we have a valid userId (not demo-user)
        if (!userId) {
          console.log('âš ï¸ Skipping Firestore fetch: userId not provided');
        } else {
          try {
            const userDocRef = doc(db, 'users', walletUserId);
          
          // Fetch wallet folders from Firestore
          const walletRef = collection(userDocRef, 'wallet');
          console.log(`ðŸ“‚ Fetching wallet collection from: /users/${walletUserId}/wallet`);
          const walletSnapshot = await getDocs(walletRef);
          
          if (!walletSnapshot.empty) {
            console.log(`ðŸ“‚ Found ${walletSnapshot.docs.length} documents in wallet collection`);
            walletSnapshot.forEach((folderDoc) => {
              const folderData = folderDoc.data();
              const folderName = folderData.sanitizedFolderName || folderDoc.id;
              console.log(`ðŸ“ Processing folder: ${folderName}`, folderData);
              
              // Create folder info
              firebaseFolders.push({
                name: folderName,
                fileCount: folderData.fileCount || 0,
                totalSize: folderData.totalSize || 0,
                lastModified: folderData.updatedAt || folderData.createdAt || new Date().toISOString()
              });
              
              // Extract files from folder data
              if (folderData.files && Array.isArray(folderData.files)) {
                folderData.files.forEach((file: any, index: number) => {
                  firebaseFiles.push({
                    id: `${folderDoc.id}-${index}-${file.name}`,
                    name: file.name,
                    type: file.type || 'application/octet-stream',
                    size: file.size || 0,
                    uploadDate: folderData.createdAt || new Date().toISOString(),
                    folder: folderName,
                    downloadURL: file.url,
                    storagePath: file.storagePath || `users/${walletUserId}/wallet/${folderName}/${file.name}`
                  });
                });
              }
            });
            
            console.log(`âœ… Fetched ${firebaseFolders.length} folders and ${firebaseFiles.length} files from Firestore`);
          } else {
            console.log('ðŸ“­ No wallet data found in Firestore');
          }
          
          // Also fetch legacy collections for backward compatibility
          const legacyCollections = ['csv-files', 'uploads'];
          for (const collectionName of legacyCollections) {
          try {
            const collectionRef = collection(userDocRef, collectionName);
            const snapshot = await getDocs(collectionRef);

            if (!snapshot.empty) {
              snapshot.forEach((docSnapshot: any) => {
                const data = docSnapshot.data();
                
                if (collectionName === 'csv-files' && data.files) {
                  data.files.forEach((file: any, index: number) => {
                      firebaseFiles.push({
                      id: `${docSnapshot.id}-${index}`,
                      name: file.name,
                      type: 'text/csv',
                      size: data.totalSize ? data.totalSize / data.files.length : 1024,
                      uploadDate: data.uploadedAt || new Date().toISOString(),
                      folder: 'csv',
                      downloadURL: file.url
                    });
                    });
                    
                    if (!firebaseFolders.find(f => f.name === 'csv')) {
                  firebaseFolders.push({
                        name: 'csv',
                        fileCount: data.files.length,
                        totalSize: data.totalSize || 0,
                        lastModified: data.uploadedAt || new Date().toISOString()
                      });
                    }
                  }
                });
            }
          } catch (error) {
            console.error(`Error fetching ${collectionName}:`, error);
          }
          }
        } catch (error) {
          console.error('âš ï¸ Error fetching from Firestore:', error);
          console.log('âš ï¸ Using local data only');
        }
        }

        // Combine local and Firebase data
        const allFolders = [...localFoldersData, ...firebaseFolders];
        const allFiles = [...localFiles, ...firebaseFiles];
        
        console.log('âœ… Final data combining:');
        console.log('   - Local files:', localFiles.length);
        console.log('   - Firebase files:', firebaseFiles.length);
        console.log('   - Total files:', allFiles.length);
        console.log('   - Local folders:', localFoldersData.length);
        console.log('   - Firebase folders:', firebaseFolders.length);
        console.log('   - Total folders:', allFolders.length);
        console.log('âœ… Final folders:', allFolders);
        console.log('âœ… Final files:', allFiles);

        console.log('ðŸ”§ SETTING STATE NOW...');
        setFolders(allFolders);
        setFiles(allFiles);
        console.log('ðŸ”§ STATE SET COMPLETE');
        
      } catch (error) {
        console.error('âŒ Error fetching wallet data:', error);
        setFolders([]);
        setFiles([]);
      }
    };

    if (isOpen) {
      fetchWalletData();
    }
  }, [isOpen, userId]); // Only depend on isOpen and userId, NOT uploadedFiles to avoid constant re-renders

  useEffect(() => {
    if (initialFolder) {
      console.log('ðŸ”§ Setting currentFolder to initialFolder:', initialFolder);
      setCurrentFolder(initialFolder);
    } else {
      console.log('âš ï¸ initialFolder is empty/null');
    }
  }, [initialFolder]);

  const getFileIcon = (type: string) => {
    if (type.startsWith('image/')) return Image;
    if (type.startsWith('video/')) return Video;
    if (type.startsWith('audio/')) return Music;
    if (type.includes('pdf')) return FileText;
    if (type.includes('zip') || type.includes('rar')) return Archive;
    if (type.includes('javascript') || type.includes('json') || type.includes('html')) return Code;
    return File;
  };

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const handleCreateFolder = async () => {
    if (!newFolderName.trim()) {
      alert('Please enter a folder name');
      return;
    }

    try {
      const sanitizedName = newFolderName.trim().toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '_');
      
      if (folders.some(f => f.name === sanitizedName)) {
        alert('Folder already exists');
        return;
      }

      // Create empty folder in Firestore
      const userDocRef = doc(db, 'users', userId || 'demo-user');
      const walletRef = collection(userDocRef, 'wallet');
      const folderDocRef = doc(walletRef, sanitizedName);
      
      await setDoc(folderDocRef, {
        folderName: newFolderName.trim(),
        sanitizedFolderName: sanitizedName,
        fileCount: 0,
        totalSize: 0,
        files: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      }, { merge: true });

      // Update local state
      const newFolder: WalletFolder = {
        name: sanitizedName,
        fileCount: 0,
        totalSize: 0,
        lastModified: new Date().toISOString()
      };

      setFolders(prev => [...prev, newFolder]);
      setNewFolderName('');
      setShowCreateFolderModal(false);
      alert(`âœ… Folder "${newFolderName}" created successfully!`);
    } catch (error) {
      console.error('Error creating folder:', error);
      alert(`âŒ Error creating folder: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  };

  const handleDeleteFolder = async (folderName: string) => {
    if (!window.confirm(`Are you sure you want to delete the folder "${folderName}" and all its contents? This action cannot be undone.`)) {
      return;
    }

    try {
      const userDocRef = doc(db, 'users', userId || 'demo-user');
      const walletRef = collection(userDocRef, 'wallet');
      const folderDocRef = doc(walletRef, folderName);
      
      // Get folder data to get storage paths
      const folderDoc = await getDocs(walletRef);
      const targetFolder = folderDoc.docs.find(d => d.id === folderName)?.data();
      
      if (targetFolder?.files && Array.isArray(targetFolder.files)) {
        // Delete files from Firebase Storage
        for (const file of targetFolder.files) {
          try {
            if (file.storagePath && !file.storagePath.startsWith('local/')) {
              const fileRef = ref(storage, file.storagePath);
              await deleteObject(fileRef);
              console.log(`âœ… Deleted file from Storage: ${file.storagePath}`);
            }
          } catch (storageError) {
            console.warn(`âš ï¸ Could not delete file from Storage: ${file.storagePath}`, storageError);
          }
        }
      }
      
      // Delete folder document from Firestore
      await deleteDoc(folderDocRef);
      console.log(`âœ… Deleted folder from Firestore: ${folderName}`);
      
      // Update local state
      setFolders(prev => prev.filter(f => f.name !== folderName));
      setFiles(prev => prev.filter(f => f.folder !== folderName));
      
      alert(`âœ… Folder "${folderName}" deleted successfully!`);
    } catch (error) {
      console.error('Error deleting folder:', error);
      alert(`âŒ Error deleting folder: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  // File action handlers
  const handleFileView = async (file: WalletFile) => {
    try {
      // Check file type and display appropriately
      const fileExtension = file.name.split('.').pop()?.toLowerCase();
      const isTextFile = ['txt', 'json', 'js', 'ts', 'jsx', 'tsx', 'html', 'css', 'md', 'py', 'java', 'cpp', 'c', 'swift'].includes(fileExtension || '');
      const isImageFile = ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(fileExtension || '');
      
      if (file.downloadURL) {
        if (isTextFile || isImageFile) {
          // Open file in a new tab/window for viewing
          window.open(file.downloadURL, '_blank');
          console.log(`Opening ${file.name} for viewing`);
        } else if (file.type.includes('json')) {
          // For JSON files, fetch and display in a modal or new window
          const response = await fetch(file.downloadURL);
          const jsonContent = await response.json();
          
          // Create a new window to display JSON content
          const newWindow = window.open('', '_blank');
          if (newWindow) {
            newWindow.document.write(`
              <html>
                <head>
                  <title>${file.name}</title>
                  <style>
                    body { font-family: monospace; padding: 20px; background: #f5f5f5; }
                    pre { background: white; padding: 15px; border-radius: 8px; overflow: auto; border: 1px solid #e5e7eb; }
                  </style>
                </head>
                <body>
                  <h2>${file.name}</h2>
                  <pre>${JSON.stringify(jsonContent, null, 2)}</pre>
                </body>
              </html>
            `);
            newWindow.document.close();
          }
          console.log(`Viewing JSON content of ${file.name}`);
        } else {
          // For other file types, just open the download URL
          window.open(file.downloadURL, '_blank');
          console.log(`Opening ${file.name}`);
        }
      } else {
        alert(`âš ï¸ Preview not available for ${file.name}\n\nFile may not be stored in Firebase Storage or preview is not supported for this file type.`);
      }
    } catch (error) {
      console.error('Error viewing file:', error);
      alert(`âš ï¸ Could not view ${file.name}: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  };

  const handleFileDownload = async (file: WalletFile) => {
    try {
      if (file.downloadURL) {
        // Download file using Firebase Storage URL
        const response = await fetch(file.downloadURL);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const blob = await response.blob();
        
        // Create a blob URL and trigger download
        const blobUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(blobUrl);
        
        console.log(`âœ… Downloaded: ${file.name}`);
        alert(`âœ… Successfully downloaded ${file.name}`);
      } else if (file.storagePath) {
        // Try to download from storage path
        try {
          const fileRef = ref(storage, file.storagePath);
          const downloadUrl = await getDownloadURL(fileRef);
          
          const response = await fetch(downloadUrl);
          const blob = await response.blob();
          
          const blobUrl = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = file.name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(blobUrl);
          
          console.log(`âœ… Downloaded: ${file.name}`);
          alert(`âœ… Successfully downloaded ${file.name}`);
        } catch (storageError) {
          console.error('Error getting download URL:', storageError);
          alert(`âš ï¸ Download URL not available for ${file.name}`);
        }
      } else {
        alert(`âš ï¸ Download URL not available for ${file.name}. This file may not be stored in Firebase Storage.`);
      }
    } catch (error) {
      console.error('Error downloading file:', error);
      alert(`âŒ Failed to download ${file.name}: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  };

  const handleFileDelete = async (file: WalletFile) => {
    if (!window.confirm(`Are you sure you want to delete ${file.name}?`)) {
      return;
    }

    // Get userId from prop or use demo-user as fallback
    const walletUserId = userId || 'demo-user';
    try {
      const userDocRef = doc(db, 'users', walletUserId);

      // Delete from Firebase Storage if storage path exists
      if (file.storagePath) {
        try {
          const fileRef = ref(storage, file.storagePath);
          await deleteObject(fileRef);
          console.log(`Deleted from Storage: ${file.storagePath}`);
        } catch (storageError) {
          console.error('Error deleting from Storage:', storageError);
          // Continue with Firestore deletion even if Storage deletion fails
        }
      }

      // Delete from Firestore wallet collection
      const walletRef = collection(userDocRef, 'wallet');
      const folderDocRef = doc(walletRef, file.folder);
      
      try {
        const folderDoc = await getDocs(collection(userDocRef, 'wallet'));
        const folderDocSnapshot = folderDoc.docs.find((d: any) => d.id === file.folder);
        
        if (folderDocSnapshot) {
          const folderData = folderDocSnapshot.data();
          
          if (folderData.files && Array.isArray(folderData.files)) {
            // Remove the file from the files array
            const updatedFiles = folderData.files.filter((f: any) => f.name !== file.name);
            
            if (updatedFiles.length === 0) {
              // If no files left, delete the entire folder document
              await deleteDoc(folderDocRef);
              console.log(`Deleted folder document from Firestore: ${file.folder}`);
            } else {
              // Update the folder document with remaining files
              await setDoc(folderDocRef, {
                ...folderData,
                files: updatedFiles,
                fileCount: updatedFiles.length,
                totalSize: updatedFiles.reduce((acc: number, f: any) => acc + (f.size || 0), 0),
                updatedAt: new Date().toISOString()
              }, { merge: true });
              console.log(`Updated folder document in Firestore: ${file.folder}`);
            }
          }
        }
        
        // Also handle legacy collections for backward compatibility
      if (file.folder === 'csv') {
        const csvRef = collection(userDocRef, 'csv-files');
        const csvSnapshot = await getDocs(csvRef);
        
        for (const docSnapshot of csvSnapshot.docs) {
          const data = docSnapshot.data();
          if (data.files && data.files.some((f: any) => f.name === file.name)) {
            await deleteDoc(doc(csvRef, docSnapshot.id));
            console.log(`Deleted from Firestore csv-files: ${docSnapshot.id}`);
          }
        }
      } else if (file.folder === 'uploads') {
        const uploadsRef = collection(userDocRef, 'uploads');
        const uploadsSnapshot = await getDocs(uploadsRef);
        
        for (const docSnapshot of uploadsSnapshot.docs) {
          const data = docSnapshot.data();
          if (data.files && data.files.some((f: any) => f.name === file.name)) {
            if (data.files.length > 1) {
              const updatedFiles = data.files.filter((f: any) => f.name !== file.name);
              await setDoc(doc(uploadsRef, docSnapshot.id), {
                ...data,
                files: updatedFiles,
                totalFiles: updatedFiles.length,
                totalSize: updatedFiles.reduce((acc: number, f: any) => acc + (f.size || 0), 0)
              });
              console.log(`Updated document in uploads: ${docSnapshot.id}`);
            } else {
              await deleteDoc(doc(uploadsRef, docSnapshot.id));
              console.log(`Deleted document from uploads: ${docSnapshot.id}`);
            }
          }
        }
        }
      } catch (firestoreError) {
        console.error('Error deleting from Firestore:', firestoreError);
      }

      // Update local state
      setFiles((prev: any[]) => prev.filter((f: any) => f.id !== file.id));
      setFolders(prev => prev.map(folder => {
        if (folder.name === file.folder) {
          return {
            ...folder,
            fileCount: Math.max(0, folder.fileCount - 1),
            totalSize: Math.max(0, folder.totalSize - file.size)
          };
        }
        return folder;
      }).filter(folder => folder.fileCount > 0)); // Remove empty folders

      alert(`${file.name} deleted successfully from Firebase!`);
    } catch (error) {
      console.error('Error deleting file:', error);
      alert(`Error deleting file: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  };

  const filteredFiles = files.filter(file => {
    const matchesSearch = file.name.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesFolder = !currentFolder || 
      file.folder === currentFolder || 
      file.folder === currentFolder.toLowerCase().replace(/\s+/g, '_') ||
      file.folder === currentFolder.replace(/\s+/g, '_');
    const matchesFilter = selectedFilter === 'all' || file.type.startsWith(selectedFilter);
    
    if (currentFolder && file.folder && !matchesFolder) {
      // Log first few mismatches to debug
      if (Math.random() < 0.02) {
        console.log('ðŸ“‹ Folder filter mismatch:', {
          looking_for: currentFolder,
          file_folder: file.folder,
          file_name: file.name,
          comparison1: file.folder === currentFolder,
          comparison2: file.folder === currentFolder.toLowerCase().replace(/\s+/g, '_'),
          comparison3: file.folder === currentFolder.replace(/\s+/g, '_')
        });
      }
    }
    
    return matchesSearch && matchesFolder && matchesFilter;
  });

  const filteredFolders = folders.filter(folder => {
    return folder.name.toLowerCase().includes(searchTerm.toLowerCase());
  });
  
  // Debug: Log current filter state
  console.log('ðŸ“º DataWallet render state:');
  console.log('   - currentFolder:', currentFolder);
  console.log('   - Total files in state:', files.length);
  console.log('   - Filtered files:', filteredFiles.length);
  console.log('   - Total folders:', folders.length);
  console.log('   - Filtered folders:', filteredFolders.length);
  
  if (currentFolder && filteredFiles.length === 0 && files.length > 0) {
    console.warn('âš ï¸ FILTERING ISSUE: currentFolder set but no files match!');
    console.log('   Files in state:', files.map(f => ({ name: f.name, folder: f.folder })));
    console.log('   Looking for folder:', currentFolder);
  }

  if (!isOpen) return null;

  return (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0, 0, 0, 0.5)',
      zIndex: 1000,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '20px'
    }}>
      <div style={{
        backgroundColor: currentTheme.cardBg,
        borderRadius: '16px',
        width: '90%',
        maxWidth: '1200px',
        height: '80vh',
        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
        display: 'flex',
        flexDirection: 'column',
        overflow: 'hidden',
        position: 'relative'
      }}>
        {/* Header */}
        <div style={{
          padding: '24px',
          borderBottom: `1px solid ${currentTheme.border}`,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
            {currentFolder && (
              <button
                onClick={() => setCurrentFolder(null)}
                style={{
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  color: currentTheme.textSecondary,
                  display: 'flex',
                  alignItems: 'center',
                  padding: '8px',
                  borderRadius: '8px',
                  transition: 'all 0.2s'
                }}
              >
                <ArrowLeft style={{ width: '20px', height: '20px' }} />
              </button>
            )}
            <h2 style={{
              fontSize: '24px',
              fontWeight: '700',
              color: currentTheme.text,
              margin: 0
            }}>
              {currentFolder ? `${currentFolder} Folder` : 'Data Wallet'}
            </h2>
          </div>
          
          <button
            onClick={() => {
              if (currentFolder) {
                // If inside a folder, close the folder view first
                setCurrentFolder(null);
              } else {
                // If at folder list, close the entire modal
                onClose();
              }
            }}
            style={{
              position: 'absolute',
              top: 16,
              right: 16,
              background: 'none',
              border: 'none',
              color: currentTheme.textSecondary,
              fontSize: 24,
              cursor: 'pointer',
              padding: 4,
              borderRadius: 4,
              transition: 'all 0.2s',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
            onMouseEnter={(e: React.MouseEvent<HTMLButtonElement>) => {
              (e.currentTarget as HTMLButtonElement).style.color = currentTheme.text;
              (e.currentTarget as HTMLButtonElement).style.backgroundColor = currentTheme.borderLight;
            }}
            onMouseLeave={(e: React.MouseEvent<HTMLButtonElement>) => {
              (e.currentTarget as HTMLButtonElement).style.color = currentTheme.textSecondary;
              (e.currentTarget as HTMLButtonElement).style.backgroundColor = 'transparent';
            }}
            title={currentFolder ? 'Close folder' : 'Close Data Wallet'}
          >
            <X style={{ width: 20, height: 20 }} />
          </button>
        </div>

        {/* Controls */}
        <div style={{
          padding: '16px 24px',
          borderBottom: `1px solid ${currentTheme.borderLight}`,
          display: 'flex',
          alignItems: 'center',
          gap: '16px',
          flexWrap: 'wrap'
        }}>
          <div style={{ position: 'relative', flex: '1', minWidth: '200px' }}>
            <Search style={{
              position: 'absolute',
              left: '12px',
              top: '50%',
              transform: 'translateY(-50%)',
              width: '16px',
              height: '16px',
              color: currentTheme.textSecondary
            }} />
            <input
              type="text"
              placeholder="Search files and folders..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              style={{
                width: '100%',
                padding: '8px 12px 8px 40px',
                border: `1px solid ${currentTheme.border}`,
                borderRadius: '8px',
                fontSize: '14px',
                backgroundColor: currentTheme.searchBg,
                color: currentTheme.text
              }}
            />
          </div>

          <select
            value={selectedFilter}
            onChange={(e) => setSelectedFilter(e.target.value)}
            style={{
              padding: '8px 12px',
              border: `1px solid ${currentTheme.border}`,
              borderRadius: '8px',
              fontSize: '14px',
              backgroundColor: currentTheme.cardBg,
              color: currentTheme.text
            }}
          >
            <option value="all">All Files</option>
            <option value="image">Images</option>
            <option value="video">Videos</option>
            <option value="text">Documents</option>
            <option value="application">Data Files</option>
          </select>

          <div style={{
            display: 'flex',
            backgroundColor: currentTheme.searchBg,
            borderRadius: '8px',
            padding: '4px'
          }}>
            <button
              onClick={() => setViewMode('grid')}
              style={{
                padding: '6px 12px',
                border: 'none',
                borderRadius: '4px',
                backgroundColor: viewMode === 'grid' ? '#3b82f6' : 'transparent',
                color: viewMode === 'grid' ? 'white' : currentTheme.textSecondary,
                cursor: 'pointer'
              }}
            >
              <Grid style={{ width: '16px', height: '16px' }} />
            </button>
            <button
              onClick={() => setViewMode('list')}
              style={{
                padding: '6px 12px',
                border: 'none',
                borderRadius: '4px',
                backgroundColor: viewMode === 'list' ? '#3b82f6' : 'transparent',
                color: viewMode === 'list' ? 'white' : currentTheme.textSecondary,
                cursor: 'pointer'
              }}
            >
              <List style={{ width: '16px', height: '16px' }} />
            </button>
          </div>

          <button
            onClick={() => setShowCreateFolderModal(true)}
            style={{
              padding: '8px 16px',
              backgroundColor: '#10b981',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              fontSize: '14px',
              fontWeight: '500',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              transition: 'all 0.2s'
            }}
            onMouseEnter={(e) => {
              (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#059669';
            }}
            onMouseLeave={(e) => {
              (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#10b981';
            }}
            title="Create a new folder"
          >
            <Plus style={{ width: '16px', height: '16px' }} />
            New Folder
          </button>
        </div>

        {/* Content */}
        <div style={{
          flex: 1,
          padding: '24px',
          overflow: 'auto'
        }}>
          {!currentFolder ? (
            <div style={{
              display: 'grid',
              gridTemplateColumns: viewMode === 'grid' ? 'repeat(auto-fill, minmax(280px, 1fr))' : '1fr',
              gap: '16px'
            }}>
              {filteredFolders.map((folder) => (
                <div
                  key={folder.name}
                  style={{
                    padding: '20px',
                    backgroundColor: currentTheme.cardBg,
                    border: `1px solid ${currentTheme.borderLight}`,
                    borderRadius: '12px',
                    transition: 'all 0.2s',
                    display: 'flex',
                    alignItems: viewMode === 'list' ? 'center' : 'flex-start',
                    gap: '16px',
                    flexDirection: viewMode === 'list' ? 'row' : 'column',
                    position: 'relative'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = currentTheme.hover;
                    e.currentTarget.style.transform = 'translateY(-2px)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = currentTheme.cardBg;
                    e.currentTarget.style.transform = 'translateY(0)';
                  }}
                >
                  <div
                    onClick={() => setCurrentFolder(folder.name)}
                    style={{
                      display: 'flex',
                      alignItems: viewMode === 'list' ? 'center' : 'flex-start',
                      gap: '16px',
                      flex: 1,
                      cursor: 'pointer'
                    }}
                  >
                    <div style={{
                      width: viewMode === 'list' ? '48px' : '64px',
                      height: viewMode === 'list' ? '48px' : '64px',
                      backgroundColor: '#3b82f6',
                      borderRadius: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      color: 'white',
                      flexShrink: 0
                    }}>
                      <Folder style={{ width: viewMode === 'list' ? '24px' : '32px', height: viewMode === 'list' ? '24px' : '32px' }} />
                    </div>
                    
                    <div style={{ flex: 1 }}>
                      <h3 style={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: currentTheme.text,
                        margin: '0 0 8px 0',
                        textTransform: 'capitalize'
                      }}>
                        {folder.name}
                      </h3>
                      <div style={{
                        fontSize: '14px',
                        color: currentTheme.textSecondary,
                        display: 'flex',
                        flexDirection: viewMode === 'list' ? 'row' : 'column',
                        gap: viewMode === 'list' ? '16px' : '4px'
                      }}>
                        <span>{folder.fileCount} files</span>
                        <span>{formatFileSize(folder.totalSize)}</span>
                        <span>Modified {formatDate(folder.lastModified)}</span>
                      </div>
                    </div>
                  </div>

                  {/* Delete Button */}
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      handleDeleteFolder(folder.name);
                    }}
                    style={{
                      padding: '4px 8px',
                      backgroundColor: 'transparent',
                      color: '#ef4444',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      transition: 'all 0.2s',
                      flexShrink: 0
                    }}
                    onMouseEnter={(e) => {
                      (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#fee2e2';
                      (e.currentTarget as HTMLButtonElement).style.color = '#dc2626';
                    }}
                    onMouseLeave={(e) => {
                      (e.currentTarget as HTMLButtonElement).style.backgroundColor = 'transparent';
                      (e.currentTarget as HTMLButtonElement).style.color = '#ef4444';
                    }}
                    title="Delete this folder"
                  >
                    <Trash2 style={{ width: '16px', height: '16px' }} />
                  </button>
                </div>
              ))}
            </div>
          ) : (
            <div style={{
              display: 'grid',
              gridTemplateColumns: viewMode === 'grid' ? 'repeat(auto-fill, minmax(200px, 1fr))' : '1fr',
              gap: '16px'
            }}>
              {filteredFiles.map((file) => {
                const FileIcon = getFileIcon(file.type);
                return (
                  <div
                    key={file.id}
                    style={{
                      padding: '16px',
                      backgroundColor: currentTheme.cardBg,
                      border: `1px solid ${currentTheme.borderLight}`,
                      borderRadius: '12px',
                      transition: 'all 0.2s',
                      display: 'flex',
                      alignItems: viewMode === 'list' ? 'center' : 'flex-start',
                      gap: '12px',
                      flexDirection: viewMode === 'list' ? 'row' : 'column'
                    }}
                  >
                    <div style={{
                      width: viewMode === 'list' ? '40px' : '48px',
                      height: viewMode === 'list' ? '40px' : '48px',
                      backgroundColor: '#f59e0b',
                      borderRadius: '8px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      color: 'white'
                    }}>
                      </div>
                    
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <h4 style={{
                        fontSize: '14px',
                        fontWeight: '600',
                        color: currentTheme.text,
                        margin: '0 0 4px 0',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap'
                      }}>
                        {file.name}
                      </h4>
                      <div style={{
                        fontSize: '12px',
                        color: currentTheme.textSecondary,
                        display: 'flex',
                        flexDirection: viewMode === 'list' ? 'row' : 'column',
                        gap: viewMode === 'list' ? '12px' : '2px'
                      }}>
                        <span>{formatFileSize(file.size)}</span>
                        <span>{formatDate(file.uploadDate)}</span>
                      </div>
                    </div>

                    {/* Action buttons for both grid and list view */}
                    <div style={{ 
                      display: 'flex', 
                      gap: '8px',
                      flexDirection: viewMode === 'grid' ? 'row' : 'row',
                      justifyContent: viewMode === 'grid' ? 'center' : 'flex-end',
                      width: viewMode === 'grid' ? '100%' : 'auto',
                      marginTop: viewMode === 'grid' ? '12px' : '0'
                    }}>
                      <button
                        onClick={() => handleFileView(file)}
                        style={{
                          padding: '6px',
                          border: 'none',
                          borderRadius: '6px',
                          backgroundColor: currentTheme.searchBg,
                          color: currentTheme.textSecondary,
                          cursor: 'pointer',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#3b82f6';
                          (e.currentTarget as HTMLButtonElement).style.color = 'white';
                        }}
                        onMouseLeave={(e) => {
                          (e.currentTarget as HTMLButtonElement).style.backgroundColor = currentTheme.searchBg;
                          (e.currentTarget as HTMLButtonElement).style.color = currentTheme.textSecondary;
                        }}
                        title="View"
                      >
                        <Eye style={{ width: '16px', height: '16px' }} />
                      </button>
                      <button
                        onClick={() => handleFileDownload(file)}
                        style={{
                          padding: '6px',
                          border: 'none',
                          borderRadius: '6px',
                          backgroundColor: currentTheme.searchBg,
                          color: currentTheme.textSecondary,
                          cursor: 'pointer',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#10b981';
                          (e.currentTarget as HTMLButtonElement).style.color = 'white';
                        }}
                        onMouseLeave={(e) => {
                          (e.currentTarget as HTMLButtonElement).style.backgroundColor = currentTheme.searchBg;
                          (e.currentTarget as HTMLButtonElement).style.color = currentTheme.textSecondary;
                        }}
                        title="Download"
                      >
                        <Download style={{ width: '16px', height: '16px' }} />
                      </button>
                      <button
                        onClick={() => handleFileDelete(file)}
                        style={{
                          padding: '6px',
                          border: 'none',
                          borderRadius: '6px',
                          backgroundColor: '#fee2e2',
                          color: '#dc2626',
                          cursor: 'pointer',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#dc2626';
                          (e.currentTarget as HTMLButtonElement).style.color = 'white';
                        }}
                        onMouseLeave={(e) => {
                          (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#fee2e2';
                          (e.currentTarget as HTMLButtonElement).style.color = '#dc2626';
                        }}
                        title="Delete"
                      >
                        <Trash2 style={{ width: '16px', height: '16px' }} />
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {((!currentFolder && filteredFolders.length === 0) || (currentFolder && filteredFiles.length === 0)) && (
            <div style={{
              textAlign: 'center',
              padding: '60px 20px',
              color: currentTheme.textSecondary
            }}>
              <Folder style={{
                width: '64px',
                height: '64px',
                margin: '0 auto 16px',
                opacity: 0.5
              }} />
              <h3 style={{
                fontSize: '18px',
                fontWeight: '600',
                margin: '0 0 8px 0'
              }}>
                {searchTerm ? 'No results found' : 'No files yet'}
              </h3>
              <p style={{
                fontSize: '14px',
                margin: 0
              }}>
                {searchTerm 
                  ? 'Try adjusting your search terms or filters' 
                  : 'Upload files to see them here'}
              </p>
            </div>
          )}
        </div>

        {/* Create Folder Modal */}
        {showCreateFolderModal && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000
          }}>
            <div style={{
              backgroundColor: currentTheme.cardBg,
              borderRadius: '12px',
              padding: '24px',
              width: '90%',
              maxWidth: '400px',
              boxShadow: '0 10px 40px rgba(0, 0, 0, 0.3)'
            }}>
              <h2 style={{
                fontSize: '18px',
                fontWeight: '600',
                marginTop: 0,
                marginBottom: '16px',
                color: currentTheme.text
              }}>
                Create New Folder
              </h2>

              <input
                type="text"
                placeholder="Enter folder name..."
                value={newFolderName}
                onChange={(e) => setNewFolderName(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleCreateFolder()}
                autoFocus
                style={{
                  width: '100%',
                  padding: '10px 12px',
                  border: `1px solid ${currentTheme.border}`,
                  borderRadius: '8px',
                  fontSize: '14px',
                  backgroundColor: currentTheme.searchBg,
                  color: currentTheme.text,
                  marginBottom: '20px',
                  boxSizing: 'border-box'
                }}
              />

              <div style={{
                display: 'flex',
                gap: '12px',
                justifyContent: 'flex-end'
              }}>
                <button
                  onClick={() => {
                    setShowCreateFolderModal(false);
                    setNewFolderName('');
                  }}
                  style={{
                    padding: '8px 16px',
                    backgroundColor: currentTheme.border,
                    color: currentTheme.text,
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: 'pointer'
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={handleCreateFolder}
                  style={{
                    padding: '8px 16px',
                    backgroundColor: '#10b981',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: 'pointer'
                  }}
                >
                  Create
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// Helper function to format bytes as human-readable string
function formatBytes(bytes: number): string {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

const EnhancedDashboard = () => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [selectedTimeframe, setSelectedTimeframe] = useState('6M');
  const [notifications, setNotifications] = useState(3);
  const [activeView, setActiveView] = useState<'dashboard' | 'annotations'>('dashboard');
  const [currentUser, setCurrentUser] = useState<FirebaseUser | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [hasAuthCheckCompleted, setHasAuthCheckCompleted] = useState(false);
  const [signupError, setSignupError] = useState('');
  const [signupLoading, setSignupLoading] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const [isConnecting, setIsConnecting] = useState(false);
  const [showAILabsModal, setShowAILabsModal] = useState(false);
  const [aiLabsApiKey, setAiLabsApiKey] = useState('');
  const [showProfileModal, setShowProfileModal] = useState(false);
  const [userProfile, setUserProfile] = useState<any>(null);
  const [dataSources, setDataSources] = useState<Array<{
    name: string;
    icon: string;
    status: string;
    lastSync: string;
    dataSize: string;
  }>>([]);
  const [hoveredCard, setHoveredCard] = useState<number | null>(null);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [hoveredSidebar, setHoveredSidebar] = useState<number | null>(null);
  const [hoveredButton, setHoveredButton] = useState<string | null>(null);
  const [hoveredDataSource, setHoveredDataSource] = useState<number | null>(null);
  const [hoveredActivity, setHoveredActivity] = useState<number | null>(null);
  const [showAddSourceModal, setShowAddSourceModal] = useState(false);
  const [datasets, setDatasets] = useState<Dataset[]>([]);
  const [showNewAddSourceModal, setShowNewAddSourceModal] = useState(false);
  const [isUploadingDataset, setIsUploadingDataset] = useState(false);
  const [walletFolders, setWalletFolders] = useState<string[]>([]);
  const [uploadedFiles, setUploadedFiles] = useState<Array<{
    name: string;
    size: number;
    type: string;
    uploadDate: string;
  }>>([]);
  const [showDataWallet, setShowDataWallet] = useState(false);
  
  // OAuth repository selection state
  const [oauthRepos, setOAuthRepos] = useState<any[]>([]);
  const [oauthProvider, setOAuthProvider] = useState<'github' | 'gitlab' | null>(null);
  const [oauthUser, setOAuthUser] = useState<any>(null);
  const [showRepoList, setShowRepoList] = useState(false);
  const [selectedLicense, setSelectedLicense] = useState<'free' | 'pro' | 'enterprise' | null>(null);
  const [isStoringConnection, setIsStoringConnection] = useState(false);
  const [selectedWalletFolder, setSelectedWalletFolder] = useState<string | null>(null);
  
  // License selection for OAuth flow
  const [showLicenseSelectionModal, setShowLicenseSelectionModal] = useState(false);
  const [pendingOAuthProvider, setPendingOAuthProvider] = useState<'github' | 'gitlab' | null>(null);
  const [pendingFileUpload, setPendingFileUpload] = useState(false);
  const [datasetDescription, setDatasetDescription] = useState('');
  const [showDescriptionModal, setShowDescriptionModal] = useState(false);
  const [pendingDatasetUpload, setPendingDatasetUpload] = useState<{
    sourceType: SourceType;
    licenseType: LicenseType;
    file: File;
  } | null>(null);
  const [recentActivity, setRecentActivity] = useState<Array<{
    action: string;
    time: string;
    type: string;
    icon: string;
    folderName?: string;
  }>>([
    { action: 'Data uploaded from Fitbit', time: '2 hours ago', type: 'upload', icon: 'âŒš' },
    { action: 'New data source connected, Twitter', time: '1 day ago', type: 'connection', icon: 'ðŸ¦' },
    { action: 'Data upload completed from GitHub', time: '3 days ago', type: 'upload', icon: 'ðŸ’»' },
    { action: 'Payment of $500 received', time: '1 week ago', type: 'payment', icon: 'ðŸ’°' }
  ]);

  // Mobile responsiveness
  const [isMobile, setIsMobile] = useState(false);
  useEffect(() => {
    const check = () => setIsMobile(typeof window !== 'undefined' && window.innerWidth < 768);
    check();
    window.addEventListener('resize', check);
    return () => window.removeEventListener('resize', check);
  }, []);

  // Firebase Auth state management
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        setCurrentUser(user);
        setIsAuthenticated(true);
        console.log('âœ… User authenticated:', user.uid);
      } else {
        setCurrentUser(null);
        setIsAuthenticated(false);
        setShowAuthModal(true);
        console.log('ðŸ‘¤ User signed out');
      }
      setHasAuthCheckCompleted(true);
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, []);

  // Monitor showDataWallet state changes
  useEffect(() => {
    console.log(`ðŸ”” DATA WALLET STATE CHANGED: showDataWallet=${showDataWallet}, selectedWalletFolder=${selectedWalletFolder}`);
  }, [showDataWallet, selectedWalletFolder]);

  // Helper function to save OAuth repos to wallet
  const saveOAuthReposToWallet = async (provider: string, user: any, repos: any[]) => {
    if (!repos || !Array.isArray(repos) || repos.length === 0) {
      console.log('âš ï¸ No repos to save');
      return;
    }

    try {
      const folderName = provider === 'github' ? 'GitHub Repositories' : 'GitLab Repositories';
      const sanitizedFolderName = folderName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').toLowerCase();
      
      const userId = auth.currentUser?.uid;
      if (!userId) {
        console.error('âŒ User not authenticated. auth.currentUser:', auth.currentUser);
        throw new Error('User not authenticated. Please sign in first.');
      }
      console.log(`ðŸ‘¤ Saving to userId: ${userId}`);
      const userDocRef = doc(db, 'users', userId);
      
      const newFiles: WalletFile[] = repos.map((repo: any) => ({
        id: `${provider}-${repo.id}-${Date.now()}`,
        name: `${repo.name}.json`,
        size: Math.floor((repo.size || 100) * 1024),
        type: 'application/json',
        uploadDate: new Date().toISOString(),
        downloadURL: repo.html_url || repo.web_url || undefined,
        storagePath: `${provider}/${sanitizedFolderName}/${repo.name}.json`,
        folder: sanitizedFolderName
      }));

      console.log(`ðŸ”„ Starting wallet save to Firestore for ${repos.length} repos...`);
      const walletRef = collection(userDocRef, 'wallet');
      const folderDocRef = doc(walletRef, sanitizedFolderName);
      
      console.log(`ðŸ“ Writing to path: /users/${userId}/wallet/${sanitizedFolderName}`);
      console.log(`ðŸ“Š Data being written:`, {
        folderName: folderName,
        sanitizedFolderName: sanitizedFolderName,
        fileCount: newFiles.length,
        totalSize: newFiles.reduce((acc, f) => acc + f.size, 0),
        files: newFiles.map(f => ({
          name: f.name,
          url: f.downloadURL,
          size: f.size,
          type: f.type,
          storagePath: f.storagePath
        }))
      });
      
      await setDoc(folderDocRef, {
        folderName: folderName,
        sanitizedFolderName: sanitizedFolderName,
        fileCount: newFiles.length,
        totalSize: newFiles.reduce((acc, f) => acc + f.size, 0),
        files: newFiles.map(f => ({
          name: f.name,
          url: f.downloadURL,
          size: f.size,
          type: f.type,
          storagePath: f.storagePath
        })),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      }, { merge: true });
      console.log(`âœ… Wallet saved to Firestore!`);
      
      // Create datasets for each repo so they appear in AI Lab API
      try {
        const datasetsRef = collection(userDocRef, 'datasets');
        const defaultLicense = 'personal';
        
        for (const repo of repos) {
          const datasetDoc = {
            title: repo.name,
            sourceName: repo.name,
            sourceType: 'github',
            licenseType: defaultLicense,
            status: 'published',
            downloads: 0,
            views: 0,
            userId: userId,
            dateAdded: new Date().toISOString(),
            fileSize: repo.size || 0,
            fileCount: 1,
            storageRef: `${provider}/${sanitizedFolderName}/${repo.name}.json`,
            metadata: {
              description: repo.description || `GitHub repository: ${repo.name}`,
              tags: [provider, 'repository', repo.language || 'unknown'],
              quality: 5,
              originalFormat: 'application/json'
            },
            earnings: {
              totalLicensed: 0,
              monthlyRevenue: 0,
              licensedToCount: 0
            },
            lastModified: new Date().toISOString()
          };
          
          await addDoc(datasetsRef, datasetDoc);
          console.log(`âœ… Dataset created for repo: ${repo.name}`);
        }
        console.log(`âœ… ${repos.length} datasets created for AI Lab API`);
      } catch (datasetError) {
        console.error('âŒ Error creating datasets for repos:', datasetError);
      }
      
      // Add data source
      const dataSourcesRef = collection(userDocRef, 'dataSources');
      console.log(`ðŸ“ Adding to dataSources...`);
      await addDoc(dataSourcesRef, {
        name: `${folderName} (${newFiles.length} repos)`,
        icon: provider === 'github' ? 'ðŸ™' : 'ðŸ¦Š',
        status: 'Active',
        lastSync: new Date().toISOString(),
        dataSize: `${newFiles.length} repositories`,
        folderName: sanitizedFolderName,
        createdAt: new Date().toISOString()
      });
      console.log(`âœ… Data source added!`);
      
      // Update local state
      console.log(`ðŸ“ Updating local state...`);
      setUploadedFiles(prev => [...newFiles, ...prev]);
      setDataSources(prev => [
        {
          name: `${folderName} (${newFiles.length} repos)`,
          icon: provider === 'github' ? 'ðŸ™' : 'ðŸ¦Š',
          status: 'Active',
          lastSync: 'Just now',
          dataSize: `${newFiles.length} repositories`
        },
        ...prev
      ]);
      setWalletFolders(prev => (prev.includes(sanitizedFolderName) ? prev : [...prev, sanitizedFolderName]));
      
      // Add activity
      addActivity(`${provider} connected (${newFiles.length} repos)`, 'connection', provider === 'github' ? 'ðŸ™' : 'ðŸ¦Š', `${provider}_repositories`);
      
      console.log(`âœ… ${provider} repos saved to wallet successfully!`);
      
      // Open Data Wallet to show the repos
      setSelectedWalletFolder(sanitizedFolderName);
      setTimeout(() => {
        setShowDataWallet(true);
      }, 500); // Small delay to ensure Firestore write is complete
    } catch (error) {
      console.error(`âŒ Error saving ${provider} repos to wallet:`, error);
      console.error(`Error type:`, error instanceof Error ? error.message : String(error));
      alert(`âŒ Error saving repos to wallet: ${error instanceof Error ? error.message : String(error)}`);
    }
  };

  // Listen for OAuth callback data from GitHub/GitLab
  useEffect(() => {
    const handleOAuthMessage = async (event: MessageEvent) => {
      console.log('ðŸ“¨ Received message:', event.data);
      console.log('ðŸ“¨ Message type:', event.data?.type);
      
      if (event.data?.type === 'github-auth-success') {
        console.log('âœ… GitHub OAuth success:', event.data.data);
        const { user, repos } = event.data.data;
        setOAuthUser(user);
        setOAuthRepos(repos || []);
        setOAuthProvider('github');
        setShowRepoList(true);
        
        // Get stored license from session
        const license = sessionStorage.getItem('selectedLicense') as 'free' | 'pro' | 'enterprise' | null;
        setSelectedLicense(license);
        sessionStorage.removeItem('selectedLicense');
        
        // Save GitHub repos to wallet in Firestore
        console.log(`ðŸ’¾ Saving ${repos?.length || 0} GitHub repos to wallet...`);
        await saveOAuthReposToWallet('github', user, repos);
      } else if (event.data?.type === 'gitlab-auth-success') {
        console.log('âœ… GitLab OAuth success:', event.data.data);
        const { user, repos } = event.data.data;
        setOAuthUser(user);
        setOAuthRepos(repos || []);
        setOAuthProvider('gitlab');
        setShowRepoList(true);
        
        // Get stored license from session
        const license = sessionStorage.getItem('selectedLicense') as 'free' | 'pro' | 'enterprise' | null;
        setSelectedLicense(license);
        sessionStorage.removeItem('selectedLicense');
        
        // Save GitLab repos to wallet in Firestore
        console.log(`ðŸ’¾ Saving ${repos?.length || 0} GitLab repos to wallet...`);
        await saveOAuthReposToWallet('gitlab', user, repos);
      } else {
        console.log('âš ï¸ Unknown message type, ignoring');
      }
    };

    window.addEventListener('message', handleOAuthMessage);
    return () => window.removeEventListener('message', handleOAuthMessage);
  }, []);

  // Helper function to get current user ID
  const getUserId = () => {
    const uid = auth.currentUser?.uid || currentUser?.uid;
    if (!uid) {
      throw new Error('User not authenticated. Please sign in first.');
    }
    return uid;
  };

  // Helper function to ensure auth is initialized
  const ensureAuthInitialized = async (): Promise<string> => {
    return new Promise((resolve, reject) => {
      // If auth is already initialized, resolve immediately
      if (auth.currentUser) {
        resolve(auth.currentUser.uid);
        return;
      }

      // If not, wait for auth state to be set (with timeout)
      const timeout = setTimeout(() => {
        reject(new Error('Auth initialization timeout'));
      }, 5000);

      const unsubscribe = onAuthStateChanged(auth, (user) => {
        clearTimeout(timeout);
        unsubscribe();
        if (user) {
          resolve(user.uid);
        } else {
          reject(new Error('User not authenticated'));
        }
      });
    });
  };

  // Load data sources from Firestore on mount
  useEffect(() => {
    const loadDataSources = async () => {
      try {
        const userId = getUserId();
        const userDocRef = doc(db, 'users', userId);
        const dataSourcesRef = collection(userDocRef, 'dataSources');
        const snapshot = await getDocs(dataSourcesRef);

        if (!snapshot.empty) {
          const loadedSources = snapshot.docs.map((doc: any) => {
            const data = doc.data();
            return {
              name: data.name || '',
              icon: data.icon || 'ðŸ“',
              status: data.status || 'Active',
              lastSync: data.lastSync || new Date().toISOString(),
              dataSize: data.dataSize || '0'
            };
          });
          setDataSources(loadedSources);
          console.log(`âœ… Loaded ${loadedSources.length} data sources from Firestore`);
        }
      } catch (error) {
        console.error('âŒ Error loading data sources from Firestore:', error);
      }
    };

    if (isAuthenticated && currentUser) {
      loadDataSources();
    }
  }, [isAuthenticated, currentUser]);

  // Load recent activity from Firestore on mount
  useEffect(() => {
    const loadRecentActivity = async () => {
      if (!isAuthenticated || !currentUser) return;
      try {
        const userId = getUserId();
        const userDocRef = doc(db, 'users', userId);
        const activitiesRef = collection(userDocRef, 'activities');
        const snapshot = await getDocs(activitiesRef);

        if (!snapshot.empty) {
          const loadedActivities = snapshot.docs
            .map((doc: any) => {
              const data = doc.data();
              return {
                action: data.action || '',
                time: data.time || 'Just now',
                type: data.type || 'upload',
                icon: data.icon || 'ðŸ“',
                folderName: data.folderName || undefined
              };
            })
            .sort((a: { action: string; time: string; type: string; icon: string; folderName?: string }, b: { action: string; time: string; type: string; icon: string; folderName?: string }) => {
              // Sort by time (most recent first)
              const timeA = a.time.includes('Just now') ? 0 : 
                           a.time.includes('hour') ? 1 : 
                           a.time.includes('day') ? 2 : 3;
              const timeB = b.time.includes('Just now') ? 0 : 
                           b.time.includes('hour') ? 1 : 
                           b.time.includes('day') ? 2 : 3;
              return timeA - timeB;
            })
            .slice(0, 10); // Limit to 10 most recent
          
          if (loadedActivities.length > 0) {
            setRecentActivity(loadedActivities);
            console.log(`âœ… Loaded ${loadedActivities.length} activities from Firestore`);
          }
        }
      } catch (error) {
        console.error('âŒ Error loading activities from Firestore:', error);
      }
    };

    if (isAuthenticated && currentUser) {
      loadRecentActivity();
    }
  }, [isAuthenticated, currentUser]);

  // Load wallet folders from Firestore on mount
  useEffect(() => {
    const loadWalletFolders = async () => {
      if (!isAuthenticated || !currentUser) return;
      try {
        const userId = getUserId();
        const userDocRef = doc(db, 'users', userId);
        const walletRef = collection(userDocRef, 'wallet');
        const snapshot = await getDocs(walletRef);

        if (!snapshot.empty) {
          const loadedFolders = snapshot.docs.map((doc: any) => {
            const data = doc.data();
            return data.sanitizedFolderName || doc.id;
          });
          setWalletFolders(loadedFolders);
          console.log(`âœ… Loaded ${loadedFolders.length} wallet folders from Firestore`);
        }
      } catch (error) {
        console.error('âŒ Error loading wallet folders from Firestore:', error);
      }
    };

    if (isAuthenticated && currentUser) {
      loadWalletFolders();
    }
  }, [isAuthenticated, currentUser]);

  // Load uploaded files summary from Firestore on mount
  useEffect(() => {
    const loadUploadedFiles = async () => {
      if (!isAuthenticated || !currentUser) return;
      try {
        const userId = getUserId();
        const userDocRef = doc(db, 'users', userId);
        const walletRef = collection(userDocRef, 'wallet');
        const snapshot = await getDocs(walletRef);

        if (!snapshot.empty) {
          const loadedFiles: Array<{
            name: string;
            size: number;
            type: string;
            uploadDate: string;
          }> = [];

          snapshot.docs.forEach((folderDoc: any) => {
            const folderData = folderDoc.data();
            if (folderData.files && Array.isArray(folderData.files)) {
              folderData.files.forEach((file: any) => {
                loadedFiles.push({
                  name: file.name || '',
                  size: file.size || 0,
                  type: file.type || 'application/octet-stream',
                  uploadDate: folderData.createdAt || new Date().toISOString()
                });
              });
            }
          });

          setUploadedFiles(loadedFiles);
          console.log(`âœ… Loaded ${loadedFiles.length} uploaded files from Firestore`);
        }
      } catch (error) {
        console.error('âŒ Error loading uploaded files from Firestore:', error);
      }
    };

    if (isAuthenticated && currentUser) {
      loadUploadedFiles();
    }
  }, [isAuthenticated, currentUser]);

  // Load datasets from Firestore on mount
  useEffect(() => {
    const loadDatasets = async () => {
      if (!isAuthenticated || !currentUser) return;
      try {
        const userId = getUserId();
        const loadedDatasets = await getDatasets(userId);
        setDatasets(loadedDatasets);
        console.log(`âœ… Loaded ${loadedDatasets.length} datasets from Firestore`);
      } catch (error) {
        console.error('âŒ Error loading datasets:', error);
      }
    };

    if (isAuthenticated && currentUser) {
      loadDatasets();
    }
  }, [isAuthenticated, currentUser]);

  // Sample data for the earnings chart
  const earningsData = [
    { month: 'Jan', value: 1200, growth: 5 },
    { month: 'Feb', value: 1400, growth: 16.7 },
    { month: 'Mar', value: 1800, growth: 28.6 },
    { month: 'Apr', value: 1600, growth: -11.1 }
  ];

  // Calculate estimated earnings based on datasets and licenses
  const calculateEstimatedEarnings = () => {
    if (datasets.length === 0) return 0;
    
    let totalEarnings = 0;
    
    datasets.forEach((dataset) => {
      // Base earnings per dataset: views * 0.01 + downloads * 0.05
      const viewsEarning = (dataset.downloads || 0) * 0.01;
      const downloadsEarning = (dataset.downloads || 0) * 0.05;
      
      // License multiplier
      const licenseMultipliers: Record<LicenseType, number> = {
        personal: 1,
        creative: 2,
        professional: 4,
        enterprise: 8
      };
      
      const multiplier = licenseMultipliers[dataset.licenseType] || 1;
      const datasetEarnings = (viewsEarning + downloadsEarning) * multiplier;
      
      totalEarnings += datasetEarnings;
    });
    
    return Math.round(totalEarnings * 100) / 100; // Round to 2 decimal places
  };

  const estimatedEarnings = calculateEstimatedEarnings();

  const theme = {
    light: {
      bg: '#f8fafc',
      cardBg: 'white',
      text: '#1e293b',
      textSecondary: '#64748b',
      border: '#e5e7eb',
      borderLight: '#f1f5f9',
      searchBg: '#f8fafc',
      sidebarBg: 'white',
      activityBg: '#f8fafc'
    },
    dark: {
      bg: '#0f172a',
      cardBg: '#1e293b',
      text: '#f1f5f9',
      textSecondary: '#94a3b8',
      border: '#334155',
      borderLight: '#475569',
      searchBg: '#334155',
      sidebarBg: '#1e293b',
      activityBg: '#334155'
    }
  };

  const currentTheme = isDarkMode ? theme.dark : theme.light;

  const sidebarItems = [
    { icon: LayoutDashboard, label: 'Dashboard', badge: null },
    { icon: BarChart3, label: 'Analytics', badge: null },
    { icon: DollarSign, label: 'Earnings', badge: 'New' },
    { icon: Tag, label: 'Annotation Services', badge: null },
    { icon: Search, label: 'AI Datasets', badge: null }
  ];

  // Handler for new dataset creation
  const handleNewDatasetAdded = async (
    sourceType: SourceType,
    licenseType: LicenseType,
    file?: File,
    sourceProvider?: string
  ) => {
    if (!currentUser) {
      alert('Please sign in to add datasets.');
      return;
    }

    // If OAuth source, redirect to OAuth connection
    if (sourceProvider && !file) {
      try {
        console.log(`ðŸ” Initiating OAuth connection: ${sourceProvider}`);
        
        // Store license type in session for later use
        sessionStorage.setItem('selectedLicense', licenseType);
        
        // Get OAuth authorization based on provider
        let authUrl = '';
        let params: Record<string, string> = {
          response_type: 'code',
          scope: '',
          redirect_uri: `${window.location.origin}/api/auth/${sourceProvider}/callback`,
          state: JSON.stringify({ 
            userId: currentUser.uid, 
            provider: sourceProvider,
            licenseType 
          }),
        };

        if (sourceProvider === 'github') {
          params.client_id = process.env.NEXT_PUBLIC_GITHUB_CLIENT_ID || '';
          params.scope = 'repo user';
          authUrl = 'https://github.com/login/oauth/authorize';
        } else if (sourceProvider === 'gitlab') {
          params.client_id = process.env.NEXT_PUBLIC_GITLAB_CLIENT_ID || '';
          params.scope = 'api read_user read_repository';
          authUrl = 'https://gitlab.com/oauth/authorize';
        } else if (sourceProvider === 'bitbucket') {
          params.client_id = process.env.NEXT_PUBLIC_BITBUCKET_CLIENT_ID || '';
          params.scope = 'repository';
          authUrl = 'https://bitbucket.org/site/oauth2/authorize';
        }

        if (!authUrl || !params.client_id) {
          throw new Error(`OAuth configuration missing for ${sourceProvider}`);
        }

        const queryString = new URLSearchParams(params).toString();
        const authUrlFull = `${authUrl}?${queryString}`;
        
        // Open in popup window instead of full page navigation
        // This allows the callback to use postMessage to send data back
        window.open(authUrlFull, 'oauth-popup', 'width=500,height=600,menubar=no,toolbar=no');
      } catch (error) {
        console.error('OAuth error:', error);
        alert(`âŒ Failed to connect ${sourceProvider}: ${error instanceof Error ? error.message : 'Unknown error'}`);
      }
      return;
    }

    if (!file) {
      console.log('Dataset added (OAuth or file missing):', { sourceType, licenseType });
      addActivity(`Connected ${sourceType} source`, 'connection', 'ðŸ”—');
      return;
    }

    // Store pending upload and show description modal
    setPendingDatasetUpload({ sourceType, licenseType, file });
    setDatasetDescription('');
    setShowDescriptionModal(true);
  };

  // Function to add new activity
  const addActivity = async (action: string, type: string, icon: string, folderName?: string) => {
    const newActivity = {
      action,
      time: 'Just now',
      type,
      icon,
      ...(folderName && { folderName }) // Only include folderName if it's defined
    };
    
    // Update local state
    setRecentActivity(prev => [newActivity, ...prev]);
    
    // Save to Firestore
    if (!isAuthenticated || !currentUser) return;
    try {
      const userId = getUserId();
      const userDocRef = doc(db, 'users', userId);
      const activitiesRef = collection(userDocRef, 'activities');
      await addDoc(activitiesRef, {
        ...newActivity,
        createdAt: new Date().toISOString()
      });
      console.log(`âœ… Activity saved to Firestore: ${action}`);
    } catch (error) {
      console.error('âŒ Error saving activity to Firestore:', error);
    }
  };

  // Handle dataset description submission
  const handleDatasetDescriptionSubmit = async () => {
    if (!pendingDatasetUpload || !currentUser) {
      alert('Upload session expired. Please try again.');
      return;
    }

    try {
      setIsUploadingDataset(true);
      const { sourceType, licenseType, file } = pendingDatasetUpload;
      const userId = currentUser.uid;

      // 1. First, create dataset in /datasets/ collection for AI Lab API
      const newDataset = await uploadDataset(
        file,
        sourceType,
        licenseType,
        userId,
        {
          description: datasetDescription || `Uploaded ${sourceType} dataset`,
          tags: [sourceType, licenseType],
        }
      );

      // 2. Then, create Data Wallet folder for the dataset
      try {
        const userDocRef = doc(db, 'users', userId);
        const folderName = `${sourceType.charAt(0).toUpperCase() + sourceType.slice(1)} - ${file.name}`;
        const sanitizedFolderName = folderName
          .replace(/[^a-zA-Z0-9\s]/g, '')
          .replace(/\s+/g, '_')
          .toLowerCase();
        
        const walletRef = collection(userDocRef, 'wallet');
        const folderDocRef = doc(walletRef, sanitizedFolderName);
        
        const walletFile = {
          id: `${sourceType}-${Date.now()}`,
          name: file.name,
          size: file.size,
          type: file.type,
          uploadDate: new Date().toISOString(),
          storagePath: newDataset.storageRef || `${sourceType}/${file.name}`,
          downloadURL: newDataset.storageRef
        };
        
        await setDoc(folderDocRef, {
          folderName: folderName,
          sanitizedFolderName: sanitizedFolderName,
          fileCount: 1,
          totalSize: file.size,
          files: [walletFile],
          license: licenseType,
          datasetId: newDataset.id,
          sourceType: sourceType,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        console.log(`âœ… Data Wallet folder created for dataset: ${sanitizedFolderName}`);
        
        // Update local state
        setWalletFolders(prev => 
          prev.includes(sanitizedFolderName) ? prev : [...prev, sanitizedFolderName]
        );
      } catch (walletError) {
        console.error('âŒ Error creating Data Wallet folder:', walletError);
      }

      setDatasets((prev) => [newDataset, ...prev]);
      addActivity(
        `${sourceType.charAt(0).toUpperCase() + sourceType.slice(1)} dataset added`,
        'upload',
        sourceType === 'code' ? 'ðŸ’»' : sourceType === 'art' ? 'ðŸŽ¨' : 'ðŸŽµ'
      );

      alert(`âœ… Dataset uploaded successfully!\\n\\nName: ${file.name}\\nDescription: ${datasetDescription || '(None)'}\\nLicense: ${licenseType}\\n\\nâœ… Visible in both Data Wallet and AI Lab API!`);
      
      // Close modal and reset state
      setShowDescriptionModal(false);
      setPendingDatasetUpload(null);
      setDatasetDescription('');
    } catch (error) {
      console.error('Error uploading dataset:', error);
      alert(`âŒ Failed to upload dataset: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setIsUploadingDataset(false);
    }
  };

  // Handle repository selection from OAuth provider
  const handleRepositorySelect = async (selectedRepos: any[]) => {
    if (!currentUser || !oauthProvider || !oauthUser) {
      alert('Authentication required');
      return;
    }

    try {
      setIsStoringConnection(true);
      const userId = currentUser.uid;
      
      // Store OAuth connection info to Firestore
      const userDocRef = doc(db, 'users', userId);
      const connectionsRef = collection(userDocRef, 'connections');
      
      // Create connection document for this OAuth provider
      const connectionDoc = {
        provider: oauthProvider,
        userId: oauthUser.id || oauthUser.login || oauthUser.username,
        userName: oauthUser.name || oauthUser.login || oauthUser.username,
        userEmail: oauthUser.email,
        userAvatar: oauthUser.avatar_url || oauthUser.avatar_url,
        accessToken: sessionStorage.getItem('oauth_access_token') || 'stored_securely', // In real app, store token in secure location
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      const connectionRef = await addDoc(connectionsRef, connectionDoc);
      const connectionId = connectionRef.id;
      
      console.log(`âœ… OAuth connection stored: ${connectionId}`);
      addActivity(`Connected ${oauthProvider} account`, 'connection', oauthProvider === 'github' ? 'ðŸ™' : 'ðŸ¦Š');
      
      // Create repository documents in Firestore
      const repositoriesRef = collection(userDocRef, 'repositories');
      
      for (const repo of selectedRepos) {
        const repoDoc = {
          name: repo.name,
          fullName: repo.full_name,
          description: repo.description || '',
          url: repo.html_url || repo.web_url || repo.url,
          provider: oauthProvider,
          providerId: repo.id,
          size: repo.size,
          stars: repo.stargazers_count || 0,
          language: repo.language || 'Unknown',
          lastUpdated: repo.updated_at,
          createdAt: new Date().toISOString(),
          connectionId: connectionId,
          synced: false
        };
        
        await addDoc(repositoriesRef, repoDoc);
      }
      
      console.log(`âœ… ${selectedRepos.length} repositories stored to Firestore`);
      
      // Create datasets for selected repos with selected license
      if (selectedLicense) {
        const datasetsRef = collection(userDocRef, 'datasets');
        
        for (const repo of selectedRepos) {
          const datasetDoc = {
            title: repo.name,
            sourceName: repo.name,
            sourceType: 'github',
            sourceProvider: oauthProvider,
            sourceConnection: connectionId,
            sourceRepo: repo.full_name,
            licenseType: selectedLicense,
            status: 'published',
            downloads: 0,
            views: 0,
            userId: userId,
            dateAdded: new Date().toISOString(),
            fileSize: repo.size || 0,
            fileCount: 1,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            metadata: {
              description: repo.description || `${oauthProvider} repository: ${repo.name}`,
              url: repo.html_url || repo.web_url || repo.url,
              stars: repo.stargazers_count || 0,
              language: repo.language || 'Unknown',
              tags: [oauthProvider, 'repository', repo.language || 'unknown']
            },
            earnings: {
              totalLicensed: 0,
              monthlyRevenue: 0,
              licensedToCount: 0
            }
          };
          
          await addDoc(datasetsRef, datasetDoc);
        }
        
        console.log(`âœ… ${selectedRepos.length} datasets created with license: ${selectedLicense}`);
        addActivity(
          `Created ${selectedRepos.length} dataset${selectedRepos.length > 1 ? 's' : ''} from ${oauthProvider}`,
          'upload',
          'ðŸ“Š'
        );
      }
      
      // Reset OAuth state
      setShowRepoList(false);
      setOAuthRepos([]);
      setOAuthProvider(null);
      setOAuthUser(null);
      
      alert(`âœ… Successfully connected and synced ${selectedRepos.length} repositories from ${oauthProvider}!`);
    } catch (error) {
      console.error('Error storing connection:', error);
      alert(`âŒ Failed to store connection: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setIsStoringConnection(false);
    }
  };

  // Function to handle activity clicks
  const handleActivityClick = (activity: { action: string; time: string; type: string; icon: string; folderName?: string }) => {
    if (activity.folderName) {
      setSelectedWalletFolder(activity.folderName);
      setShowDataWallet(true);
    }
  };

  // Handle file upload with license selection
  const handleUploadFilesWithLicense = (onClose: () => void) => {
    console.log('ðŸš€ handleUploadFilesWithLicense called');
    if (!isAuthenticated || !currentUser) {
      alert('Please sign in to upload files.');
      return;
    }
    // Show license selection modal before opening file upload
    console.log('ðŸ“‹ Showing license selection modal for file upload');
    setShowLicenseSelectionModal(true);
    setPendingFileUpload(true);
    onClose(); // Close the data source modal
  };

  // File upload handler - MUST BE DEFINED BEFORE proceedWithFileUpload
  const handleFileUpload = (onClose: () => void, sourceName?: string) => {
    console.log('ðŸš€ handleFileUpload function executing');
    console.log('   - onClose:', typeof onClose);
    console.log('   - sourceName:', sourceName);
    if (!isAuthenticated || !currentUser) {
      console.warn('âš ï¸ User not authenticated');
      alert('Please sign in to upload files.');
      return;
    }
    console.log('ðŸš€ File upload initiated with source:', sourceName);
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '*/*'; // Accept all file types
    input.multiple = true;
    
    // Helper function to validate file
    const isValidCodeFile = (file: File): boolean => {
      const fileName = file.name.toLowerCase();
      const fileExtension = fileName.substring(fileName.lastIndexOf('.'));

      // Blocked file types that should never be uploaded
      const BLOCKED_EXTENSIONS = [
        '.xlsx', '.xls', '.xlsm', '.xlsb', // Excel
        '.docx', '.doc', '.docm', // Word
        '.pptx', '.ppt', '.pptm', // PowerPoint
        '.pdf', // PDF
        '.jpg', '.jpeg', '.png', '.gif', '.bmp', '.svg', '.ico', // Images
        '.mp4', '.avi', '.mov', '.mkv', '.mp3', '.wav', '.flac', // Media
        '.exe', '.dll', '.so', '.dylib', // Binaries
      ];

      const BLOCKED_MIME_TYPES = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
        'application/vnd.ms-excel', // .xls
        'application/vnd.ms-excel.sheet.binary.macroEnabled.12', // .xlsb
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
        'application/msword', // .doc
        'application/vnd.openxmlformats-officedocument.presentationml.presentation', // .pptx
        'application/vnd.ms-powerpoint', // .ppt
        'application/pdf', // .pdf
        'image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/svg+xml', // Images
        'audio/mpeg', 'audio/wav', 'video/mp4', 'video/quicktime', // Media
      ];

      // Check if blocked by MIME type
      if (BLOCKED_MIME_TYPES.includes(file.type)) {
        return false;
      }

      // Check if blocked by extension
      if (BLOCKED_EXTENSIONS.includes(fileExtension)) {
        return false;
      }

      return true;
    };
    
    input.onchange = async (e) => {
      const files = (e.target as HTMLInputElement).files;
      console.log('ðŸ“ Files selected:', files ? files.length : 0);
      
      if (files && files.length > 0) {
        // Validate all files before processing
        const invalidFiles: string[] = [];
        const validFiles: File[] = [];
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!isValidCodeFile(file)) {
            invalidFiles.push(`${file.name} (${file.type || 'unknown type'})`);
          } else {
            validFiles.push(file);
          }
        }

        // Show error if any files are invalid
        if (invalidFiles.length > 0) {
          let errorMsg = `âŒ ${invalidFiles.length} file(s) not allowed:\n\n`;
          invalidFiles.slice(0, 5).forEach(f => {
            errorMsg += `â€¢ ${f}\n`;
          });
          if (invalidFiles.length > 5) {
            errorMsg += `â€¢ ... and ${invalidFiles.length - 5} more\n`;
          }
          errorMsg += `\nOnly code files are accepted. Excel, Word, PowerPoint, PDF, images, and media files are not permitted.`;
          alert(errorMsg);
        }

        // If all files were invalid, return
        if (validFiles.length === 0) {
          console.warn('âŒ No valid files to upload');
          return;
        }

        // If some files were valid, continue with those
        if (validFiles.length < files.length) {
          console.warn(`âš ï¸ Processing ${validFiles.length} valid file(s) out of ${files.length} selected`);
        }

        try {
          // Create a labeled folder name based on source or timestamp
          const folderName = sourceName || `Desktop Upload ${new Date().toLocaleDateString()}`;
          const sanitizedFolderName = folderName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').toLowerCase();
          
          console.log(`ðŸ“‚ Creating folder: "${folderName}" (ID: ${sanitizedFolderName})`);

          console.log(`ðŸ“¤ Processing ${validFiles.length} file(s) for folder: ${folderName}...`);

          const userId = getUserId();
          setIsUploading(true);
          
          const userDocRef = doc(db, 'users', userId);
          const walletRef = collection(userDocRef, 'wallet');
          const folderDocRef = doc(walletRef, sanitizedFolderName);

          // Upload files in parallel with concurrency limit (5 at a time)
          const uploadConcurrency = 5;
          const uploadPromises: Promise<any>[] = [];
          
          for (let i = 0; i < validFiles.length; i++) {
            const uploadPromise = (async () => {
              const file = validFiles[i];
              const fileIndex = i;
              
              console.log(`ðŸ“„ Processing file ${fileIndex + 1}/${validFiles.length}: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
              
              try {
                // Upload file to Firebase Storage
                const storagePath = `users/${userId}/wallet/${sanitizedFolderName}/${file.name}`;
                const storageRef = ref(storage, storagePath);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                
                console.log(`âœ… File uploaded to Storage: ${storagePath}`);
                
                // Create file data with Firebase URLs
                const fileData: WalletFile = {
                  id: `${Date.now()}-${fileIndex}-${file.name}`,
                  name: file.name,
                  size: file.size,
                  type: file.type || 'application/octet-stream',
                  uploadDate: new Date().toISOString(),
                  downloadURL: downloadURL,
                  storagePath: storagePath,
                  folder: sanitizedFolderName
                };
                
                return {
                  success: true,
                  fileData,
                  fileRef: { 
                    name: file.name, 
                    url: downloadURL,
                    size: file.size,
                    type: file.type || 'application/octet-stream',
                    storagePath: storagePath
                  }
                };
              } catch (storageError) {
                console.error(`âŒ Error uploading ${file.name} to Storage:`, storageError);
                // Fallback to local file data if Storage upload fails
                const fileData: WalletFile = {
                  id: `${Date.now()}-${fileIndex}-${file.name}`,
                  name: file.name,
                  size: file.size,
                  type: file.type || 'application/octet-stream',
                  uploadDate: new Date().toISOString(),
                  downloadURL: URL.createObjectURL(file),
                  storagePath: `local/${sanitizedFolderName}/${file.name}`,
                  folder: sanitizedFolderName
                };
                
                return {
                  success: true,
                  fileData,
                  fileRef: { 
                    name: file.name, 
                    url: URL.createObjectURL(file),
                    size: file.size,
                    type: file.type || 'application/octet-stream',
                    storagePath: `local/${sanitizedFolderName}/${file.name}`
                  }
                };
              }
            })();
            
            uploadPromises.push(uploadPromise);
            
            // Wait for some uploads to complete before starting new ones (concurrency control)
            if (uploadPromises.length >= uploadConcurrency) {
              await Promise.race(uploadPromises);
              uploadPromises.splice(0, uploadPromises.length - (uploadConcurrency - 1));
            }
          }
          
          // Wait for all remaining uploads to complete
          const uploadResults = await Promise.all(uploadPromises);
          
          // Extract file data and refs from results
          const newFiles: WalletFile[] = [];
          const fileRefs: any[] = [];
          
          uploadResults.forEach((result) => {
            if (result?.fileData) {
              newFiles.push(result.fileData);
              fileRefs.push(result.fileRef);
            }
          });

          // Save folder metadata to Firestore
          try {
            const license = sessionStorage.getItem('uploadFilesLicense') || 'free';
            await setDoc(folderDocRef, {
              folderName: folderName,
              sanitizedFolderName: sanitizedFolderName,
              fileCount: newFiles.length,
              totalSize: newFiles.reduce((acc, f) => acc + f.size, 0),
              files: fileRefs,
              license: license,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            }, { merge: true });
            
            console.log(`âœ… Folder metadata saved to Firestore: ${sanitizedFolderName} (License: ${license})`);
          } catch (firestoreError) {
            console.error('âŒ Error saving to Firestore:', firestoreError);
          }

          // Save data source to Firestore
          try {
            const license = sessionStorage.getItem('uploadFilesLicense') || 'free';
            const dataSourcesRef = collection(userDocRef, 'dataSources');
            await addDoc(dataSourcesRef, {
              name: `${folderName} (${newFiles.length} files)`,
              icon: 'ðŸ“',
              status: 'Active',
              lastSync: new Date().toISOString(),
              dataSize: `${newFiles.length} file${newFiles.length > 1 ? 's' : ''}`,
              folderName: sanitizedFolderName,
              license: license,
              type: 'file_upload',
              createdAt: new Date().toISOString()
            });
            console.log(`âœ… Data source saved to Firestore (License: ${license})`);
          } catch (dataSourceError) {
            console.error('âŒ Error saving data source to Firestore:', dataSourceError);
          }

          // Create dataset for the uploaded files to show in AI Lab API
          try {
            const license = sessionStorage.getItem('uploadFilesLicense') || 'personal';
            const datasetsRef = collection(userDocRef, 'datasets');
            
            // Create a single dataset that represents the entire upload folder
            const datasetDoc = {
              id: sanitizedFolderName,
              title: folderName,
              sourceName: folderName,
              sourceType: 'code',
              licenseType: license,
              status: 'uploaded',
              downloads: 0,
              metadata: {
                description: `Uploaded ${folderName} containing ${newFiles.length} file${newFiles.length > 1 ? 's' : ''}`,
                tags: ['code', 'upload', folderName],
                quality: 'high',
                folderName: sanitizedFolderName,
                fileCount: newFiles.length,
                totalSize: newFiles.reduce((acc, f) => acc + f.size, 0)
              },
              fileData: newFiles.map(f => ({
                name: f.name,
                size: f.size,
                type: f.type,
                downloadURL: f.downloadURL,
                storagePath: f.storagePath
              })),
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };
            
            await addDoc(datasetsRef, datasetDoc);
            console.log(`âœ… Dataset created for uploaded files: ${folderName}`);
          } catch (datasetError) {
            console.error('âŒ Error creating dataset for uploaded files:', datasetError);
          }

          console.log('ðŸ’¾ Updating local state...');

          // Update local state
          setUploadedFiles(prev => [...newFiles, ...prev]);

          const newSource = { 
            name: `${folderName} (${files.length} files)`,
            icon: 'ðŸ“',
            status: 'Active',
            lastSync: 'Just now',
            dataSize: `${newFiles.length} file${newFiles.length > 1 ? 's' : ''}`
          };

          setDataSources(prev => [newSource, ...prev]);
          
          setWalletFolders(prev => {
            if (!prev.includes(sanitizedFolderName)) {
              console.log(`ðŸ“ Adding new folder to wallet: ${sanitizedFolderName}`);
              return [...prev, sanitizedFolderName];
            }
            return prev;
          });

          // Add activity
          addActivity(`Data uploaded from ${folderName}`, 'upload', 'ðŸ“', sanitizedFolderName);

          // Don't call onClose - the Add Data Source modal is already closed by the license selection flow
          // onClose();
          
          const totalSize = newFiles.reduce((acc, file) => acc + file.size, 0);
          const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
          
          // Enhanced success message with folder details
          const fileList = Array.from(files).map(f => `â€¢ ${f.name} (${(f.size / 1024).toFixed(1)} KB)`).join('\n');
          
          setIsUploading(false);
          console.log('âœ… Upload completed successfully!');
          console.log(`ðŸ“Š Uploaded files:`, newFiles.map(f => ({ name: f.name, folder: f.folder })));
          
          // Show success message
          alert(`ðŸŽ‰ UPLOAD SUCCESSFUL!\n\nðŸ“ Folder: "${folderName}"\nðŸ“Š Files: ${files.length}\nðŸ’¾ Total Size: ${sizeInMB} MB\n\nðŸ“‹ File Details:\n${fileList}\n\nâœ… Your files are now available in the Data Wallet!`);
          
          // Wait a moment to ensure Firestore writes are complete, then open wallet
          console.log(`â±ï¸ Waiting for Firestore to complete, then opening Data Wallet...`);
          setTimeout(() => {
            console.log(`ðŸ” Opening Data Wallet with folder: ${sanitizedFolderName}`);
            setSelectedWalletFolder(sanitizedFolderName);
            setShowDataWallet(true);
          }, 3000); // Wait 3 seconds to ensure all Firestore writes complete and modals close

        } catch (error) {
          setIsUploading(false);
          console.error('âŒ Error during file upload:', error);
          alert(`âŒ UPLOAD FAILED\n\nError: ${error instanceof Error ? error.message : 'Unknown error'}\n\nPlease try again.`);
        }
      } else {
        console.log('âš ï¸ No files selected');
      }
    };

    console.log('ðŸ–±ï¸ Triggering file input click...');
    input.click();
  };

  // Proceed with file upload after license selection
  const proceedWithFileUpload = (licenseType: string) => {
    console.log(`ðŸ“ proceedWithFileUpload called with license: ${licenseType}`);
    console.log(`ðŸ“ Current state - pendingFileUpload: ${pendingFileUpload}`);
    // Store license in session for use during upload
    sessionStorage.setItem('uploadFilesLicense', licenseType);
    console.log('ðŸ“ Closing license modal and calling handleFileUpload');
    setShowLicenseSelectionModal(false);
    setPendingFileUpload(false);
    // Trigger the file upload dialog
    console.log('ðŸš€ About to call handleFileUpload');
    try {
      handleFileUpload(() => {}, 'Desktop Files');
      console.log('âœ… handleFileUpload called successfully');
    } catch (error) {
      console.error('âŒ Error calling handleFileUpload:', error);
    }
  };

  // GitHub connection handler (real OAuth via popup, local only)
  const handleGitHubConnection = (onClose: () => void) => {
    if (!isAuthenticated || !currentUser) {
      alert('Please sign in to connect data sources.');
      return;
    }
    // Show license selection modal before opening OAuth popup
    setShowLicenseSelectionModal(true);
    setPendingOAuthProvider('github');
    onClose(); // Close the data source modal
  };

  // Open OAuth popup after license selection
  const handleOAuthWithLicense = (provider: string, licenseType: string) => {
    try {
      // Store license in session before opening popup
      sessionStorage.setItem('selectedLicense', licenseType);
      
      if (provider === 'github') {
        const popup = window.open('/api/auth/github/start', 'github-auth', 'width=600,height=720');
        if (!popup) {
          alert('Please allow popups to connect GitHub.');
          return;
        }
      } else if (provider === 'gitlab') {
        const popup = window.open('/api/auth/gitlab/start', 'gitlab-auth', 'width=600,height=720');
        if (!popup) {
          alert('Please allow popups to connect GitLab.');
          return;
        }
      }
      
      setShowLicenseSelectionModal(false);
      // The useEffect OAuth message handler will take care of the rest
    } catch (error) {
      console.error(`âŒ Error during ${provider} connection:`, error);
      alert(`âŒ ${provider.toUpperCase()} CONNECTION FAILED\n\nError: ${error instanceof Error ? error.message : 'Unknown error'}\n\nPlease try again.`);
    }
  };

  // OLD GitHub connection handler - DEPRECATED, keeping for backward compatibility
  const handleGitHubConnectionOld = (onClose: () => void) => {
    if (!isAuthenticated || !currentUser) {
      alert('Please sign in to connect data sources.');
      return;
    }
    try {
      const popup = window.open('/api/auth/github/start', 'github-auth', 'width=600,height=720');
      if (!popup) {
        alert('Please allow popups to connect GitHub.');
        return;
      }
      const messageHandler = async (event: MessageEvent) => {
        if (!event.data || event.data.type !== 'github-auth-success') return;
        const { user, repos } = event.data.data || {};
        if (!repos || !Array.isArray(repos)) return;

      const folderName = 'GitHub Repositories';
      const sanitizedFolderName = folderName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').toLowerCase();
      setIsConnecting(true);
      
      const userId = getUserId();
      const userDocRef = doc(db, 'users', userId);
      
        const newFiles: WalletFile[] = repos.map((repo: any) => ({
          id: `github-${repo.id}-${Date.now()}`,
          name: `${repo.name}.json`,
          size: Math.floor((repo.size || 100) * 1024),
          type: 'application/json',
          uploadDate: new Date().toISOString(),
          downloadURL: repo.html_url || undefined,
          storagePath: `github/${sanitizedFolderName}/${repo.name}.json`,
          folder: sanitizedFolderName
        }));

        // Save to Firestore
        try {
          const walletRef = collection(userDocRef, 'wallet');
          const folderDocRef = doc(walletRef, sanitizedFolderName);
          
          await setDoc(folderDocRef, {
            folderName: folderName,
            sanitizedFolderName: sanitizedFolderName,
            fileCount: newFiles.length,
            totalSize: newFiles.reduce((acc, f) => acc + f.size, 0),
            files: newFiles.map(f => ({
              name: f.name,
              url: f.downloadURL,
              size: f.size,
              type: f.type,
              storagePath: f.storagePath
            })),
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }, { merge: true });
          
          const dataSourcesRef = collection(userDocRef, 'dataSources');
          await addDoc(dataSourcesRef, {
            name: `${folderName} (${newFiles.length} repos)`,
            icon: 'ðŸ”—',
            status: 'Active',
            lastSync: new Date().toISOString(),
            dataSize: `${newFiles.length} repositories`,
            folderName: sanitizedFolderName,
            createdAt: new Date().toISOString()
          });
          
          console.log(`âœ… GitHub data saved to Firestore`);
        } catch (firestoreError) {
          console.error('âŒ Error saving GitHub data to Firestore:', firestoreError);
        } finally {
          setIsConnecting(false);
        }

      setUploadedFiles(prev => [...newFiles, ...prev]);
        setDataSources(prev => [
          {
            name: `${folderName} (${newFiles.length} repos)`,
        icon: 'ðŸ”—',
        status: 'Active',
        lastSync: 'Just now',
            dataSize: `${newFiles.length} repositories`
          },
          ...prev
        ]);
        setWalletFolders(prev => (prev.includes(sanitizedFolderName) ? prev : [...prev, sanitizedFolderName]));

        // Add activity
        addActivity(`GitHub connected (${newFiles.length} repos)`, 'connection', 'ðŸ”—', 'github_repositories');

        window.removeEventListener('message', messageHandler);
        onClose();

        setTimeout(() => {
          setSelectedWalletFolder(sanitizedFolderName);
          setShowDataWallet(true);
        }, 300);
      };
      window.addEventListener('message', messageHandler);
    } catch (error) {
      console.error('âŒ Error during GitHub connection:', error);
      alert(`âŒ GITHUB CONNECTION FAILED\n\nError: ${error instanceof Error ? error.message : 'Unknown error'}\n\nPlease try again.`);
    }
  };

  // Twitter/X connection handler (real OAuth via popup, local only)
  const handleTwitterConnection = (onClose: () => void) => {
    if (!isAuthenticated || !currentUser) {
      alert('Please sign in to connect data sources.');
      return;
    }
    try {
      const popup = window.open('/api/auth/twitter/start', 'twitter-auth', 'width=600,height=720');
      if (!popup) {
        alert('Please allow popups to connect Twitter/X.');
        return;
      }
      const messageHandler = async (event: MessageEvent) => {
        if (!event.data || event.data.type !== 'twitter-auth-success') return;
        const { user, tweets } = event.data.data || {};
        if (!user) return;

        const folderName = 'Twitter/X Data';
        const sanitizedFolderName = folderName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').toLowerCase();
        setIsConnecting(true);
        
        const userId = getUserId();
        const userDocRef = doc(db, 'users', userId);

        const newFiles: WalletFile[] = [];

        // Create user profile file
        newFiles.push({
          id: `twitter-user-${user.id}-${Date.now()}`,
          name: `${user.username}_profile.json`,
          size: JSON.stringify(user).length,
          type: 'application/json',
          uploadDate: new Date().toISOString(),
          downloadURL: `https://twitter.com/${user.username}`,
          storagePath: `twitter/${sanitizedFolderName}/${user.username}_profile.json`,
          folder: sanitizedFolderName
        });

        // Create tweets file if available
        if (tweets && Array.isArray(tweets) && tweets.length > 0) {
          newFiles.push({
            id: `twitter-tweets-${user.id}-${Date.now()}`,
            name: `${user.username}_tweets.json`,
            size: JSON.stringify(tweets).length,
            type: 'application/json',
            uploadDate: new Date().toISOString(),
            downloadURL: `https://twitter.com/${user.username}`,
            storagePath: `twitter/${sanitizedFolderName}/${user.username}_tweets.json`,
            folder: sanitizedFolderName
          });
        }

        // Save to Firestore
        try {
          const walletRef = collection(userDocRef, 'wallet');
          const folderDocRef = doc(walletRef, sanitizedFolderName);
          
          await setDoc(folderDocRef, {
            folderName: folderName,
            sanitizedFolderName: sanitizedFolderName,
            fileCount: newFiles.length,
            totalSize: newFiles.reduce((acc, f) => acc + f.size, 0),
            files: newFiles.map(f => ({
              name: f.name,
              url: f.downloadURL,
              size: f.size,
              type: f.type,
              storagePath: f.storagePath,
              data: f.name.includes('profile') ? user : (f.name.includes('tweets') ? tweets : null)
            })),
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }, { merge: true });
          
          const dataSourcesRef = collection(userDocRef, 'dataSources');
          await addDoc(dataSourcesRef, {
            name: `${folderName} (@${user.username})`,
            icon: 'ðŸ¦',
            status: 'Active',
            lastSync: new Date().toISOString(),
            dataSize: `${newFiles.length} files`,
            folderName: sanitizedFolderName,
            createdAt: new Date().toISOString()
          });
          
          console.log(`âœ… Twitter data saved to Firestore`);
        } catch (firestoreError) {
          console.error('âŒ Error saving Twitter data to Firestore:', firestoreError);
        } finally {
          setIsConnecting(false);
        }

        setUploadedFiles(prev => [...newFiles, ...prev]);
        setDataSources(prev => [
          {
            name: `${folderName} (@${user.username})`,
            icon: 'ðŸ¦',
            status: 'Active',
            lastSync: 'Just now',
            dataSize: `${newFiles.length} files`
          },
          ...prev
        ]);
        setWalletFolders(prev => (prev.includes(sanitizedFolderName) ? prev : [...prev, sanitizedFolderName]));

        // Add activity
        addActivity(`Twitter/X connected (@${user.username})`, 'connection', 'ðŸ¦', 'twitter_x_data');

        window.removeEventListener('message', messageHandler);
        onClose();
      
      setTimeout(() => {
        setSelectedWalletFolder(sanitizedFolderName);
        setShowDataWallet(true);
        }, 300);
      };
      window.addEventListener('message', messageHandler);
    } catch (error) {
      console.error('âŒ Error during Twitter connection:', error);
      alert(`âŒ TWITTER CONNECTION FAILED\n\nError: ${error instanceof Error ? error.message : 'Unknown error'}\n\nPlease try again.`);
    }
  };

  const sourceOptions = [
    { 
      name: 'Upload Files', 
      icon: 'ðŸ“', 
      description: 'Upload any file type (CSV, PDF, images, etc.)',
      onClick: (onClose: () => void) => handleUploadFilesWithLicense(onClose)
    },
    { 
      name: 'GitHub', 
      icon: 'ðŸ”—', 
      description: 'Connect your GitHub repositories',
      onClick: (onClose: () => void) => handleGitHubConnection(onClose)
    },
    { 
      name: 'API Connection', 
      icon: 'ðŸ”Œ', 
      description: 'Connect via REST API',
      onClick: async (onClose: () => void) => {
        if (!isAuthenticated || !currentUser) {
          alert('Please sign in to connect data sources.');
          return;
        }
        const newSource = { 
          name: 'API Connection',
          icon: 'ðŸ”Œ',
          status: 'Active',
          lastSync: 'Just now',
          dataSize: 'Real-time'
        };
        
        // Save to Firestore
        try {
          const userId = getUserId();
          const userDocRef = doc(db, 'users', userId);
          const dataSourcesRef = collection(userDocRef, 'dataSources');
          await addDoc(dataSourcesRef, {
            name: 'API Connection',
            icon: 'ðŸ”Œ',
            status: 'Active',
            lastSync: new Date().toISOString(),
            dataSize: 'Real-time',
            createdAt: new Date().toISOString()
          });
          console.log(`âœ… API Connection saved to Firestore`);
        } catch (firestoreError) {
          console.error('âŒ Error saving API Connection to Firestore:', firestoreError);
        }
        
        setDataSources(prev => [newSource, ...prev]);
        
        // Add activity
        addActivity('API connection established', 'connection', 'ðŸ”Œ');
        
        onClose();
        alert('API connection established!');
      }
    },
    { 
      name: 'Twitter/X', 
      icon: 'ðŸ¦', 
      description: 'Connect your Twitter/X account',
      onClick: (onClose: () => void) => handleTwitterConnection(onClose)
    },
    { 
      name: 'LinkedIn', 
      icon: 'ðŸ’¼', 
      description: 'Connect your LinkedIn profile',
      onClick: async (onClose: () => void) => {
        if (!isAuthenticated || !currentUser) {
          alert('Please sign in to connect data sources.');
          return;
        }
        const newSource = { 
          name: 'LinkedIn',
          icon: 'ðŸ’¼',
          status: 'Active',
          lastSync: 'Just now',
          dataSize: 'Professional data'
        };
        
        // Save to Firestore
        try {
          const userId = getUserId();
          const userDocRef = doc(db, 'users', userId);
          const dataSourcesRef = collection(userDocRef, 'dataSources');
          await addDoc(dataSourcesRef, {
            name: 'LinkedIn',
            icon: 'ðŸ’¼',
            status: 'Active',
            lastSync: new Date().toISOString(),
            dataSize: 'Professional data',
            createdAt: new Date().toISOString()
          });
          console.log(`âœ… LinkedIn connection saved to Firestore`);
        } catch (firestoreError) {
          console.error('âŒ Error saving LinkedIn connection to Firestore:', firestoreError);
        }
        
        setDataSources(prev => [newSource, ...prev]);
        
        // Add activity
        addActivity('LinkedIn connection established', 'connection', 'ðŸ’¼');
        
        onClose();
        alert('LinkedIn connection established!');
      }
    }
  ];

  // Custom tooltip component for the chart
  const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
      return (
        <div style={{
          backgroundColor: 'white',
          padding: '8px 12px',
          border: '1px solid #e5e7eb',
          borderRadius: '6px',
          boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }}>
          <p style={{ margin: '0', fontSize: '14px', fontWeight: '500' }}>{`$${payload[0].value}`}</p>
          <p style={{ margin: '4px 0 0 0', fontSize: '12px', color: '#64748b' }}>{label}</p>
        </div>
      );
    }
    return null;
  };

  const handleRefresh = () => {
    setIsRefreshing(true);
    setTimeout(() => setIsRefreshing(false), 2000);
  };

  const toggleTheme = () => {
    setIsDarkMode(!isDarkMode);
  };

  const handleViewWallet = (folder?: string) => {
    setSelectedWalletFolder(folder || null);
    setShowDataWallet(true);
  };

  // Google Sign-in handler
  // Google Sign In Handler
  const handleGoogleSignIn = async () => {
    try {
      console.log('ðŸ” Google sign-in initiated...');
      setSignupLoading(true);
      setSignupError('');
      
      const provider = new GoogleAuthProvider();
      provider.addScope('profile');
      provider.addScope('email');
      
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      
      console.log('âœ… Google sign-in successful!', user.uid);
      
      // Store/update user profile in Firestore
      const userDocRef = doc(db, 'users', user.uid);
      await setDoc(userDocRef, {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName || 'Google User',
        photoURL: user.photoURL || '',
        authProvider: 'google',
        createdAt: new Date().toISOString(),
        dataSources: [],
        wallet: [],
        apiKeys: []
      }, { merge: true }); // merge: true to not overwrite existing data
      
      console.log('âœ… User profile updated in Firestore');
      
      setIsAuthenticated(true);
      setCurrentUser(user);
      setSignupError('');
      setSignupLoading(false);
      
      alert('ðŸŽ‰ Welcome to Datta Studio!\n\nYou have successfully signed in with Google.');
    } catch (error: any) {
      console.error('âŒ Google sign-in error:', error);
      setSignupLoading(false);
      
      if (error.code === 'auth/popup-closed-by-user') {
        setSignupError('Sign-in was cancelled. Please try again.');
      } else if (error.code === 'auth/popup-blocked') {
        setSignupError('Popup was blocked. Please allow popups for this site and try again.');
      } else {
        setSignupError(error.message || 'Failed to sign in with Google. Please try again.');
      }
    }
  };

  // GitHub Sign In Handler
  const handleGithubSignIn = async () => {
    try {
      console.log('ðŸ” GitHub sign-in initiated...');
      setSignupLoading(true);
      setSignupError('');
      
      const provider = new GithubAuthProvider();
      provider.addScope('user:email');
      provider.addScope('read:user');
      
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      
      console.log('âœ… GitHub sign-in successful!', user.uid);
      
      // Store/update user profile in Firestore
      const userDocRef = doc(db, 'users', user.uid);
      await setDoc(userDocRef, {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName || 'GitHub User',
        photoURL: user.photoURL || '',
        authProvider: 'github',
        createdAt: new Date().toISOString(),
        dataSources: [],
        wallet: [],
        apiKeys: []
      }, { merge: true });
      
      console.log('âœ… User profile updated in Firestore');
      
      setIsAuthenticated(true);
      setCurrentUser(user);
      setSignupError('');
      setSignupLoading(false);
      
      alert('ðŸŽ‰ Welcome to Datta Studio!\n\nYou have successfully signed in with GitHub.');
    } catch (error: any) {
      console.error('âŒ GitHub sign-in error:', error);
      setSignupLoading(false);
      
      if (error.code === 'auth/popup-closed-by-user') {
        setSignupError('Sign-in was cancelled. Please try again.');
      } else if (error.code === 'auth/account-exists-with-different-credential') {
        setSignupError('An account with this email already exists. Try a different sign-in method.');
      } else {
        setSignupError(error.message || 'Failed to sign in with GitHub. Please try again.');
      }
    }
  };

  // Logout Handler
  const handleLogout = async () => {
    try {
      console.log('ðŸšª Signing out...');
      await signOut(auth);
      setIsAuthenticated(false);
      setCurrentUser(null);
      setShowAuthModal(true);
      console.log('âœ… User signed out successfully');
      alert('ðŸ‘‹ You have been signed out.');
    } catch (error: any) {
      console.error('âŒ Logout error:', error);
      alert('Error logging out: ' + error.message);
    }
  };

  // Authentication Modal Component
  const GoogleSignInModal = () => {
    if (isAuthenticated || !showAuthModal) return null;
    
    return (
      <div
        style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          zIndex: 9999,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '20px',
          overflow: 'auto'
        }}
      >
        <div
          style={{
            backgroundColor: currentTheme.cardBg,
            borderRadius: '20px',
            padding: '48px',
            maxWidth: '420px',
            width: '100%',
            textAlign: 'center',
            boxShadow: '0 25px 50px rgba(0, 0, 0, 0.5)',
            border: `1px solid ${currentTheme.borderLight}`,
            maxHeight: '90vh',
            overflowY: 'auto'
          }}
        >
          {/* Logo */}
          <div style={{
            width: '80px',
            height: '80px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '20px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            color: 'white',
            fontSize: '32px',
            fontWeight: 'bold',
            margin: '0 auto 24px',
            boxShadow: '0 8px 32px rgba(102, 126, 234, 0.4)'
          }}>
            D
          </div>

          {/* Title */}
          <h1 style={{
            fontSize: '28px',
            fontWeight: '700',
            color: currentTheme.text,
            margin: '0 0 8px 0'
          }}>
            Welcome to Datta Studio
          </h1>
          
          <p style={{
            fontSize: '16px',
            color: currentTheme.textSecondary,
            margin: '0 0 24px 0',
            lineHeight: '1.5'
          }}>
            Turn your work, code, and creativity into data that earns everytime it trains AI
          </p>

          {/* Error Message */}
          {signupError && (
            <div style={{
              backgroundColor: '#fee2e2',
              color: '#dc2626',
              padding: '12px 16px',
              borderRadius: '8px',
              fontSize: '14px',
              marginBottom: '16px',
              border: '1px solid #fecaca'
            }}>
              {signupError}
            </div>
          )}

          {/* Google Sign-in Button */}
          <button
            onClick={handleGoogleSignIn}
            disabled={signupLoading}
            style={{
              width: '100%',
              backgroundColor: signupLoading ? '#f5f5f5' : 'white',
              color: signupLoading ? '#9ca3af' : '#1f2937',
              border: '1px solid #dadce0',
              borderRadius: '12px',
              padding: '14px 16px',
              fontSize: '16px',
              fontWeight: '600',
              cursor: signupLoading ? 'not-allowed' : 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '12px',
              transition: 'all 0.2s',
              boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
              opacity: signupLoading ? 0.7 : 1,
              marginBottom: '12px'
            }}
            onMouseEnter={(e) => {
              if (!signupLoading) {
                e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                e.currentTarget.style.transform = 'translateY(-1px)';
              }
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
          >
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>

          {/* GitHub Sign-in Button */}
          <button
            onClick={handleGithubSignIn}
            disabled={signupLoading}
            style={{
              width: '100%',
              backgroundColor: signupLoading ? '#f5f5f5' : (isDarkMode ? '#1f2937' : '#000000'),
              color: 'white',
              border: '1px solid #374151',
              borderRadius: '12px',
              padding: '14px 16px',
              fontSize: '16px',
              fontWeight: '600',
              cursor: signupLoading ? 'not-allowed' : 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '12px',
              transition: 'all 0.2s',
              boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
              opacity: signupLoading ? 0.7 : 1,
              marginBottom: '12px'
            }}
            onMouseEnter={(e) => {
              if (!signupLoading) {
                e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                e.currentTarget.style.transform = 'translateY(-1px)';
              }
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
          >
            <Github style={{ width: '20px', height: '20px' }} />
            Continue with GitHub
          </button>

          {/* Footer */}
          <p style={{
            fontSize: '12px',
            color: currentTheme.textSecondary,
            margin: '0',
            lineHeight: '1.4'
          }}>
            By signing in, you agree to our{' '}
            <a href="#" style={{ color: '#667eea', textDecoration: 'none', fontWeight: '600' }}>Terms of Service</a>
            {' '}and{' '}
            <a href="#" style={{ color: '#667eea', textDecoration: 'none', fontWeight: '600' }}>Privacy Policy</a>
          </p>
        </div>
      </div>
    );
  };

  // AI Labs API Modal Component
  const AILabsModal = ({ open, onClose }: { open: boolean; onClose: () => void }) => {
    if (!open) return null;

    const [connectionStatus, setConnectionStatus] = useState<'idle' | 'connecting' | 'connected'>('idle');
    const [apiKey, setApiKey] = useState<string>('');
    const [connectionId, setConnectionId] = useState<string>('');
    const [showApiKey, setShowApiKey] = useState(false);
    const [modalDatasets, setModalDatasets] = useState<any[]>([]);
    const [loadingDatasets, setLoadingDatasets] = useState(false);
    const [datasetsLoaded, setDatasetsLoaded] = useState(false);

    // Load datasets from Firestore when modal opens (with caching)
    useEffect(() => {
      const loadDatasetsFromFirestore = async () => {
        if (!isAuthenticated || !currentUser) return;
        
        // Use cached datasets if available
        if (datasetsLoaded && modalDatasets.length > 0) {
          console.log('ðŸ“¦ Using cached datasets');
          return;
        }
        
        try {
          setLoadingDatasets(true);
          const userId = getUserId();
          console.log('ðŸ“‚ Loading datasets for user:', userId);
          const datasets = await getDatasets(userId, 20); // Limit to 20 initially
          console.log('âœ… Datasets loaded for AI Labs modal:', datasets);
          console.log('ðŸ“Š Total datasets:', datasets?.length || 0);
          setModalDatasets(datasets || []);
          setDatasetsLoaded(true);
        } catch (error) {
          console.error('Error loading datasets:', error);
          setModalDatasets([]);
          setDatasetsLoaded(true);
        } finally {
          setLoadingDatasets(false);
        }
      };

      if (open) {
        loadDatasetsFromFirestore();
      }
    }, [open, isAuthenticated, currentUser, datasetsLoaded]);

    // Check if connection already exists
    useEffect(() => {
      const checkExistingConnection = async () => {
        if (!isAuthenticated || !currentUser) return;
        
        try {
          const userId = getUserId();
          const userDocRef = doc(db, 'users', userId);
          const aiLabsRef = collection(userDocRef, 'aiLabConnections');
          const snapshot = await getDocs(aiLabsRef);

          if (!snapshot.empty) {
            const connection = snapshot.docs[0].data();
            setConnectionId(connection.connectionId);
            setConnectionStatus('connected');
            
            // Try to get API key
            const response = await fetch(`/api/pilot/api-key?connectionId=${connection.connectionId}`);
            if (response.ok) {
              const data = await response.json();
              if (data.apiKey) {
                setApiKey(data.apiKey);
              }
            }
          }
        } catch (error) {
          console.error('Error checking connection:', error);
        }
      };

      if (open) {
        checkExistingConnection();
      }
    }, [open, isAuthenticated, currentUser]);

    const handleConnectAILab = async () => {
      if (!isAuthenticated || !currentUser) {
        alert('Please sign in to enable AI lab connections.');
        return;
      }

      try {
        setConnectionStatus('connecting');
        
        // Ensure auth is fully initialized before attempting write
        const userId = await ensureAuthInitialized();
        console.log('ðŸ”‘ Creating AI Lab connection for user:', userId);
        
        const userDocRef = doc(db, 'users', userId);
        const aiLabsRef = collection(userDocRef, 'aiLabConnections');

        const newConnectionId = `ai_lab_${Math.random().toString(36).substr(2, 16)}`;

        // First, create the AI Lab connection in Firestore
        console.log('ðŸ“ Attempting to write to Firestore:', {
          path: `users/${userId}/aiLabConnections`,
          connectionId: newConnectionId,
          authUid: auth.currentUser?.uid
        });

        await addDoc(aiLabsRef, {
          connectionId: newConnectionId,
          status: 'active',
          createdAt: new Date().toISOString(),
          lastAccessed: null,
          datasetAccessCount: 0,
          authorizedDatasets: [],
          requestsProcessed: 0
        });

        console.log('âœ… Firestore write successful');

        // Get API key from server
        const response = await fetch('/api/pilot/api-key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ connectionId: newConnectionId, userId }),
        });

        const responseData = await response.json();

        if (response.ok) {
          const apiKey = responseData.apiKey;
          
          console.log('ðŸ” API key generated successfully');
          
          // Save API key to Firestore on client side
          const apiKeysRef = collection(userDocRef, 'apiKeys');
          await addDoc(apiKeysRef, {
            connectionId: newConnectionId,
            apiKey: apiKey,
            status: 'active',
            createdAt: new Date().toISOString(),
            requestCount: 0,
            datasetAccessCount: 0,
          });

          setApiKey(apiKey);
          setConnectionId(newConnectionId);
          setConnectionStatus('connected');
          
          console.log('âœ… AI Lab connection established successfully');
          alert(`âœ… AI Lab connection enabled!\n\nAPI Key: ${apiKey.substring(0, 20)}...`);
        } else {
          const errorMsg = responseData.error || 'Failed to create API key';
          console.error('âŒ API Error:', errorMsg, 'Status:', response.status);
          throw new Error(errorMsg);
        }
      } catch (error) {
        console.error('âŒ Error enabling AI lab connection:', error);
        setConnectionStatus('idle');
        const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';
        
        // Provide more specific error messages
        let userMessage = errorMessage;
        if (errorMessage.includes('permission') || errorMessage.includes('Permission')) {
          userMessage = 'Permission denied. Your Firebase security rules may need to be updated. Please check the Firestore rules in Firebase Console.';
        } else if (errorMessage.includes('auth') || errorMessage.includes('timeout')) {
          userMessage = 'Authentication error. Please sign out and sign back in.';
        }
        
        console.error('ðŸ“‹ Full error details:', {
          message: errorMessage,
          userAuth: currentUser?.uid,
          authUser: auth.currentUser?.uid,
          timestamp: new Date().toISOString()
        });
        
        alert(`Failed to enable AI lab connection: ${userMessage}`);
      }
    };

    const handleDisconnectAILab = async () => {
      if (!isAuthenticated || !currentUser || !connectionId) {
        alert('Not connected. Please sign in first.');
        return;
      }

      const confirmMessage = 
        'âš ï¸ DISABLE AI LAB CONNECTION\n\n' +
        'Are you sure you want to disable the AI Lab connection?\n\n' +
        'â€¢ AI labs will no longer be able to access your datasets\n' +
        'â€¢ Your current API key will become invalid\n' +
        'â€¢ When you re-enable later, you\'ll receive a NEW API key\n\n' +
        'Do you want to continue?';

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        setConnectionStatus('connecting');
        
        const userId = await ensureAuthInitialized();
        console.log('ðŸ”“ Disabling AI Lab connection for user:', userId);
        
        const userDocRef = doc(db, 'users', userId);
        const aiLabsRef = collection(userDocRef, 'aiLabConnections');
        
        // Get and delete the connection document
        const snapshot = await getDocs(aiLabsRef);
        for (const connDoc of snapshot.docs) {
          await deleteDoc(connDoc.ref);
        }

        // Also delete associated API keys
        const apiKeysRef = collection(userDocRef, 'apiKeys');
        const apiKeysSnapshot = await getDocs(apiKeysRef);
        for (const keyDoc of apiKeysSnapshot.docs) {
          if (keyDoc.data().connectionId === connectionId) {
            await deleteDoc(keyDoc.ref);
          }
        }

        console.log('âœ… AI Lab connection disabled successfully');
        
        setConnectionStatus('idle');
        setApiKey('');
        setConnectionId('');
        setShowApiKey(false);
        
        alert('âœ… AI Lab connection disabled successfully. Your datasets are no longer visible to external AI labs.');
      } catch (error) {
        console.error('âŒ Error disabling AI lab connection:', error);
        setConnectionStatus('idle');
        const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';
        alert(`Failed to disable AI lab connection: ${errorMessage}`);
      }
    };

    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0, 0, 0, 0.5)',
        zIndex: 2000,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px'
      }}>
        <div style={{
          backgroundColor: currentTheme.cardBg,
          borderRadius: '16px',
          padding: '32px',
          maxWidth: '700px',
          width: '100%',
          boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
          maxHeight: '90vh',
          overflowY: 'auto'
        }}>
          <button
            onClick={onClose}
            style={{
              position: 'absolute',
              top: '16px',
              right: '16px',
              background: 'none',
              border: 'none',
              color: currentTheme.textSecondary,
              fontSize: '24px',
              cursor: 'pointer',
              padding: '4px'
            }}
          >
            <X style={{ width: '20px', height: '20px' }} />
          </button>

          <h2 style={{
            fontSize: '24px',
            fontWeight: '700',
            color: currentTheme.text,
            marginBottom: '8px',
            marginTop: 0
          }}>
            ðŸ”Œ AI Labs Dataset Connection
          </h2>

          <p style={{
            fontSize: '13px',
            color: currentTheme.textSecondary,
            marginTop: 0,
            marginBottom: '24px'
          }}>
            Enable external AI laboratories and research teams to discover and access your datasets
          </p>

          {/* Connection Status Card */}
          <div style={{
            backgroundColor: connectionStatus === 'connected' ? (isDarkMode ? '#10b98115' : '#d1fae515') : currentTheme.activityBg,
            borderLeft: `4px solid ${connectionStatus === 'connected' ? '#10b981' : '#7c3aed'}`,
            padding: '16px',
            borderRadius: '8px',
            marginBottom: '24px'
          }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
              marginBottom: '12px'
            }}>
              <div style={{
                width: '12px',
                height: '12px',
                borderRadius: '50%',
                backgroundColor: connectionStatus === 'connected' ? '#10b981' : (connectionStatus === 'connecting' ? '#f59e0b' : '#9ca3af'),
                animation: connectionStatus === 'connecting' ? 'pulse 2s infinite' : 'none'
              }} />
              <span style={{
                fontWeight: '600',
                color: currentTheme.text,
                fontSize: '14px'
              }}>
                {connectionStatus === 'idle' && 'Not Connected'}
                {connectionStatus === 'connecting' && 'Connecting...'}
                {connectionStatus === 'connected' && 'Connected'}
              </span>
            </div>
            {connectionStatus === 'connected' && (
              <p style={{
                margin: 0,
                fontSize: '13px',
                color: currentTheme.textSecondary
              }}>
                âœ… Your datasets are now discoverable by AI labs on the network
              </p>
            )}
          </div>

          {/* Available Datasets Section */}
          <div style={{
            marginBottom: '24px'
          }}>
            <h3 style={{
              fontSize: '14px',
              fontWeight: '600',
              color: currentTheme.text,
              marginTop: 0,
              marginBottom: '12px',
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}>
              <Database style={{ width: '16px', height: '16px' }} />
              Published Datasets ({modalDatasets.length})
            </h3>
            
            <div style={{
              backgroundColor: currentTheme.activityBg,
              borderRadius: '12px',
              padding: '16px',
              maxHeight: '250px',
              overflowY: 'auto'
            }}>
              {loadingDatasets ? (
                <div style={{
                  textAlign: 'center',
                  padding: '24px',
                  color: currentTheme.textSecondary
                }}>
                  <Loader style={{
                    width: '24px',
                    height: '24px',
                    margin: '0 auto 12px',
                    animation: 'spin 1s linear infinite'
                  }} />
                  <p style={{ margin: 0, fontSize: '13px' }}>
                    Loading your datasets...
                  </p>
                </div>
              ) : modalDatasets.length === 0 ? (
                <div style={{
                  textAlign: 'center',
                  padding: '24px',
                  color: currentTheme.textSecondary
                }}>
                  <Folder style={{
                    width: '32px',
                    height: '32px',
                    margin: '0 auto 12px',
                    opacity: 0.5
                  }} />
                  <p style={{ margin: 0, fontSize: '13px' }}>
                    No datasets available yet. Upload data to share with AI labs.
                  </p>
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                  {modalDatasets.map((dataset, idx) => (
                    <div key={idx} style={{
                      padding: '12px',
                      backgroundColor: currentTheme.cardBg,
                      borderRadius: '8px',
                      borderLeft: '3px solid #7c3aed',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'start'
                    }}>
                      <div style={{ flex: 1 }}>
                        <div style={{
                          fontWeight: '500',
                          color: currentTheme.text,
                          fontSize: '13px',
                          marginBottom: '4px'
                        }}>
                          {dataset.sourceName || dataset.fileName || 'Unnamed Dataset'}
                        </div>
                        <div style={{
                          fontSize: '12px',
                          color: currentTheme.textSecondary
                        }}>
                          {formatBytes(dataset.fileSize)} â€¢ {dataset.sourceType}
                        </div>
                      </div>
                      <div style={{
                        backgroundColor: isDarkMode ? '#10b98120' : '#10b98130',
                        color: '#10b981',
                        padding: '4px 10px',
                        borderRadius: '4px',
                        fontSize: '11px',
                        fontWeight: '600',
                        whiteSpace: 'nowrap',
                        marginLeft: '12px'
                      }}>
                        Available
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* How It Works */}
          <div style={{
            backgroundColor: currentTheme.activityBg,
            borderRadius: '12px',
            padding: '16px',
            marginBottom: '24px'
          }}>
            <h3 style={{
              fontSize: '14px',
              fontWeight: '600',
              color: currentTheme.text,
              marginTop: 0,
              marginBottom: '12px'
            }}>
              ðŸ“‹ How It Works
            </h3>
            <ol style={{
              margin: 0,
              paddingLeft: '20px',
              fontSize: '13px',
              color: currentTheme.textSecondary,
              lineHeight: '1.8'
            }}>
              <li>Enable the connection below to make your datasets visible</li>
              <li>AI labs discover your datasets through the platform network</li>
              <li>They request access or license data for their projects</li>
              <li>You approve/deny requests and set usage terms</li>
              <li>Get paid for licensed datasets used in AI training</li>
            </ol>
          </div>

          {/* Benefits */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: '1fr 1fr',
            gap: '12px',
            marginBottom: '24px'
          }}>
            <div style={{
              backgroundColor: isDarkMode ? '#3b82f615' : '#dbeafe',
              padding: '12px',
              borderRadius: '8px',
              borderLeft: '3px solid #3b82f6'
            }}>
              <div style={{
                fontWeight: '600',
                fontSize: '12px',
                color: '#3b82f6',
                marginBottom: '4px'
              }}>
                ðŸ’¡ Monetize
              </div>
              <div style={{
                fontSize: '12px',
                color: currentTheme.textSecondary
              }}>
                Earn revenue from AI labs licensing your data
              </div>
            </div>
            <div style={{
              backgroundColor: isDarkMode ? '#8b5cf615' : '#fef3c7',
              padding: '12px',
              borderRadius: '8px',
              borderLeft: '3px solid #f59e0b'
            }}>
              <div style={{
                fontWeight: '600',
                fontSize: '12px',
                color: '#f59e0b',
                marginBottom: '4px'
              }}>
                ðŸ” Discover
              </div>
              <div style={{
                fontSize: '12px',
                color: currentTheme.textSecondary
              }}>
                Get discovered by leading AI research teams
              </div>
            </div>
            <div style={{
              backgroundColor: isDarkMode ? '#10b98115' : '#d1fae5',
              padding: '12px',
              borderRadius: '8px',
              borderLeft: '3px solid #10b981'
            }}>
              <div style={{
                fontWeight: '600',
                fontSize: '12px',
                color: '#10b981',
                marginBottom: '4px'
              }}>
                ðŸ“Š Analytics
              </div>
              <div style={{
                fontSize: '12px',
                color: currentTheme.textSecondary
              }}>
                Track usage and licensing requests in real-time
              </div>
            </div>
            <div style={{
              backgroundColor: isDarkMode ? '#ec407a15' : '#fce4ec',
              padding: '12px',
              borderRadius: '8px',
              borderLeft: '3px solid #ec407a'
            }}>
              <div style={{
                fontWeight: '600',
                fontSize: '12px',
                color: '#ec407a',
                marginBottom: '4px'
              }}>
                ðŸ›¡ï¸ Control
              </div>
              <div style={{
                fontSize: '12px',
                color: currentTheme.textSecondary
              }}>
                Approve who can access your data
              </div>
            </div>
          </div>

          {/* API Key Display */}
          {connectionStatus === 'connected' && apiKey && (
            <div style={{
              backgroundColor: isDarkMode ? '#1e293b' : '#f8fafc',
              border: `1px solid ${currentTheme.border}`,
              borderRadius: '8px',
              padding: '16px',
              marginBottom: '24px'
            }}>
              <h3 style={{
                fontSize: '14px',
                fontWeight: '600',
                color: currentTheme.text,
                marginTop: 0,
                marginBottom: '12px',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }}>
                ðŸ”‘ API Key
              </h3>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                marginBottom: '12px'
              }}>
                <code style={{
                  flex: 1,
                  padding: '10px',
                  backgroundColor: isDarkMode ? '#0f172a' : 'white',
                  border: `1px solid ${currentTheme.border}`,
                  borderRadius: '6px',
                  fontSize: '12px',
                  fontFamily: 'monospace',
                  color: currentTheme.text,
                  wordBreak: 'break-all'
                }}>
                  {showApiKey ? apiKey : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'}
                </code>
                <button
                  onClick={() => setShowApiKey(!showApiKey)}
                  style={{
                    padding: '8px 12px',
                    border: `1px solid ${currentTheme.border}`,
                    borderRadius: '6px',
                    backgroundColor: currentTheme.cardBg,
                    color: currentTheme.text,
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: '500'
                  }}
                >
                  {showApiKey ? 'ðŸ‘ï¸ Hide' : 'ðŸ‘ï¸ Show'}
                </button>
                <button
                  onClick={() => {
                    navigator.clipboard.writeText(apiKey);
                    alert('API key copied to clipboard!');
                  }}
                  style={{
                    padding: '8px 12px',
                    border: `1px solid ${currentTheme.border}`,
                    borderRadius: '6px',
                    backgroundColor: '#3b82f6',
                    color: 'white',
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: '500'
                  }}
                >
                  ðŸ“‹ Copy
                </button>
              </div>
              <div style={{
                fontSize: '12px',
                color: currentTheme.textSecondary,
                marginBottom: '8px'
              }}>
                <strong>API Endpoint:</strong> <code style={{ color: '#3b82f6' }}>{typeof window !== 'undefined' ? window.location.origin : ''}/api/pilot/datasets</code>
              </div>
              <div style={{
                fontSize: '11px',
                color: currentTheme.textSecondary,
                padding: '8px',
                backgroundColor: isDarkMode ? '#1e3a8a20' : '#dbeafe',
                borderRadius: '4px',
                borderLeft: '3px solid #3b82f6'
              }}>
                <strong>Usage:</strong> Include this API key in the <code>X-API-Key</code> header when making requests to the API.
              </div>
            </div>
          )}

          {/* Action Buttons */}
          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
            {connectionStatus !== 'connected' && (
              <button
                onClick={handleConnectAILab}
                disabled={connectionStatus === 'connecting'}
                style={{
                  padding: '12px',
                  borderRadius: '8px',
                  border: 'none',
                  backgroundColor: '#7c3aed',
                  color: 'white',
                  cursor: connectionStatus === 'connecting' ? 'not-allowed' : 'pointer',
                  fontWeight: '600',
                  fontSize: '14px',
                  opacity: connectionStatus === 'connecting' ? 0.7 : 1,
                  transition: 'all 0.2s'
                }}
              >
                {connectionStatus === 'idle' && 'ðŸš€ Enable AI Lab Connection'}
                {connectionStatus === 'connecting' && 'â³ Connecting...'}
              </button>
            )}

            {connectionStatus === 'connected' && (
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={handleDisconnectAILab}
                  style={{
                    flex: 1,
                    padding: '12px',
                    borderRadius: '8px',
                    border: 'none',
                    backgroundColor: '#ef4444',
                    color: 'white',
                    cursor: 'pointer',
                    fontWeight: '600',
                    fontSize: '14px',
                    transition: 'all 0.2s'
                  }}
                >
                  ðŸ”“ Disable Connection
                </button>
                <button
                  style={{
                    flex: 1,
                    padding: '12px',
                    borderRadius: '8px',
                    border: 'none',
                    backgroundColor: '#10b981',
                    color: 'white',
                    cursor: 'default',
                    fontWeight: '600',
                    fontSize: '14px'
                  }}
                >
                  âœ… Connected
                </button>
              </div>
            )}
            
            <button
              onClick={onClose}
              style={{
                padding: '12px',
                border: `1px solid ${currentTheme.border}`,
                borderRadius: '8px',
                backgroundColor: currentTheme.cardBg,
                color: currentTheme.text,
                cursor: 'pointer',
                fontWeight: '500',
                fontSize: '14px'
              }}
            >
              Close
            </button>
          </div>

          <style>{`
            @keyframes pulse {
              0%, 100% { opacity: 1; }
              50% { opacity: 0.7; }
            }
          `}</style>
        </div>
      </div>
    );
  };

  // Source Picker Modal Component
  // Profile Modal Component
  const ProfileModal = ({ open, onClose }: { open: boolean; onClose: () => void }) => {
    if (!open) return null;

    const [activeTab, setActiveTab] = useState<'profile' | 'settings' | 'requests' | 'security' | 'billing'>('profile');
    const [isEditing, setIsEditing] = useState(false);
    const [editName, setEditName] = useState(currentUser?.displayName || '');
    const [editEmail, setEditEmail] = useState(currentUser?.email || '');
    
    // REMOVED OLD CODE - START
    const _AccessRequestsTab = () => {
      const [pendingRequests, setPendingRequests] = useState<any[]>([]);
      const [loadingRequests, setLoadingRequests] = useState(true);
      const [approvingId, setApprovingId] = useState<string | null>(null);
      const userId = currentUser?.uid || '';

      // Fetch pending requests on mount
      React.useEffect(() => {
        const fetchRequests = async () => {
          try {
            setLoadingRequests(true);
            const userDocRef = doc(db, 'users', userId);
            const accessRequestsRef = collection(userDocRef, 'accessRequests');
            const q = query(accessRequestsRef, where('status', '==', 'pending'));
            const snapshot = await getDocs(q);
            
            const requests = snapshot.docs.map((docSnap) => {
              const data = docSnap.data();
              return {
                id: docSnap.id,
                requesterName: data.requesterName || '',
                requesterEmail: data.requesterEmail || '',
                company: data.company || '',
                datasetId: data.datasetId || '',
                datasetTitle: data.datasetTitle || '',
                purpose: data.purpose || '',
                status: data.status || 'pending',
                createdAt: data.createdAt || new Date().toISOString()
              };
            });
            
            setPendingRequests(requests);
          } catch (error) {
            console.error('Error fetching access requests:', error);
          } finally {
            setLoadingRequests(false);
          }
        };

        if (userId) {
          fetchRequests();
        }
      }, [userId]);

      const handleApproveRequest = async (requestId: string) => {
        try {
          setApprovingId(requestId);
          
          // Generate API key
          const apiKey = `datta_${Math.random().toString(36).substr(2, 40)}`;
          const expiryDate = new Date();
          expiryDate.setDate(expiryDate.getDate() + 30);

          // Get request details for email
          const userDocRef = doc(db, 'users', userId);
          const requestRef = doc(userDocRef, 'accessRequests', requestId);
          const requestDoc = await getDoc(requestRef);
          const requestData = requestDoc.data();
          
          if (!requestData) {
            alert('Request not found');
            return;
          }

          // Create connection record
          const connectionId = `public_req_${requestId}`;
          const connectionsRef = collection(userDocRef, 'aiLabConnections');
          await addDoc(connectionsRef, {
            connectionId,
            requesterEmail: requestData.requesterEmail,
            requesterName: requestData.requesterName,
            requesterCompany: requestData.requesterCompany,
            status: 'active',
            createdAt: new Date().toISOString(),
            expiresAt: expiryDate,
            accessRequestId: requestId
          });

          // Create API key record
          const apiKeysRef = collection(userDocRef, 'apiKeys');
          await addDoc(apiKeysRef, {
            connectionId,
            apiKey,
            status: 'active',
            createdAt: new Date().toISOString(),
            expiresAt: expiryDate,
            requesterEmail: requestData.requesterEmail,
            requesterName: requestData.requesterName,
            requestCount: 0,
            datasetAccessCount: 0
          });

          // Update request status
          await updateDoc(requestRef, {
            status: 'approved',
            approvedAt: new Date().toISOString(),
            apiKeyGenerated: true,
            apiKey,
            connectionId,
            expiresAt: expiryDate
          });

          // Send email with API key
          const emailResponse = await fetch('/api/email/send-api-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              requesterEmail: requestData.requesterEmail,
              requesterName: requestData.requesterName,
              datasetTitle: requestData.datasetTitle || 'Dataset',
              apiKey
            })
          });

          if (emailResponse.ok) {
            console.log('âœ… API key email sent to:', requestData.requesterEmail);
          } else {
            console.warn('âš ï¸ Failed to send API key email');
          }

          // Remove from pending list
          setPendingRequests(requests => requests.filter(r => r.id !== requestId));
          alert(`âœ… Request approved! API key sent to ${requestData.requesterEmail}`);
        } catch (error) {
          console.error('Error approving request:', error);
          alert('Failed to approve request: ' + (error instanceof Error ? error.message : 'Unknown error'));
        } finally {
          setApprovingId(null);
        }
      };

      const handleRejectRequest = async (requestId: string) => {
        try {
          if (!window.confirm('Are you sure you want to reject this request?')) {
            return;
          }

          const userDocRef = doc(db, 'users', userId);
          const requestRef = doc(userDocRef, 'accessRequests', requestId);
          
          await updateDoc(requestRef, {
            status: 'rejected',
            rejectedAt: new Date().toISOString()
          });

          setPendingRequests(requests => requests.filter(r => r.id !== requestId));
          alert('Request rejected');
        } catch (error) {
          console.error('Error rejecting request:', error);
          alert('Failed to reject request');
        }
      };

      if (loadingRequests) {
        return (
          <div style={{
            backgroundColor: currentTheme.activityBg,
            borderRadius: '12px',
            padding: '24px',
            textAlign: 'center',
            color: currentTheme.textSecondary
          }}>
            <Loader style={{
              width: '24px',
              height: '24px',
              margin: '0 auto 12px',
              animation: 'spin 1s linear infinite'
            }} />
            Loading requests...
          </div>
        );
      }

      if (pendingRequests.length === 0) {
        return (
          <div style={{
            backgroundColor: currentTheme.activityBg,
            borderRadius: '12px',
            padding: '24px',
            textAlign: 'center',
            color: currentTheme.textSecondary
          }}>
            <FileText style={{
              width: '40px',
              height: '40px',
              margin: '0 auto 12px',
              opacity: 0.5
            }} />
            <p style={{ margin: 0, fontSize: '14px' }}>
              No pending requests. You'll be notified by email when new requests arrive.
            </p>
          </div>
        );
      }

      return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
          {pendingRequests.map(request => (
            <div key={request.id} style={{
              backgroundColor: currentTheme.cardBg,
              border: `1px solid ${currentTheme.border}`,
              borderRadius: '12px',
              padding: '16px',
              display: 'flex',
              flexDirection: 'column',
              gap: '12px'
            }}>
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'start'
              }}>
                <div>
                  <div style={{
                    fontWeight: '600',
                    color: currentTheme.text,
                    fontSize: '14px'
                  }}>
                    {request.requesterName}
                  </div>
                  <div style={{
                    fontSize: '13px',
                    color: currentTheme.textSecondary
                  }}>
                    {request.requesterCompany}
                  </div>
                </div>
                <div style={{
                  backgroundColor: '#fef3c7',
                  color: '#92400e',
                  padding: '4px 12px',
                  borderRadius: '6px',
                  fontSize: '11px',
                  fontWeight: '600'
                }}>
                  Pending
                </div>
              </div>

              <div style={{
                backgroundColor: currentTheme.activityBg,
                padding: '12px',
                borderRadius: '8px',
                fontSize: '13px',
                color: currentTheme.textSecondary
              }}>
                <strong>Dataset:</strong> {request.datasetTitle || 'Unknown'}<br/>
                <strong>Email:</strong> {request.requesterEmail}<br/>
                <strong>Purpose:</strong> {request.purpose}
              </div>

              <div style={{
                display: 'flex',
                gap: '8px',
                justifyContent: 'flex-end'
              }}>
                <button
                  onClick={() => handleRejectRequest(request.id)}
                  style={{
                    padding: '8px 16px',
                    backgroundColor: '#fee2e2',
                    color: '#991b1b',
                    border: 'none',
                    borderRadius: '6px',
                    fontSize: '12px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#fecaca';
                  }}
                  onMouseLeave={(e) => {
                    (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#fee2e2';
                  }}
                >
                  Reject
                </button>
                <button
                  onClick={() => handleApproveRequest(request.id)}
                  disabled={approvingId === request.id}
                  style={{
                    padding: '8px 16px',
                    backgroundColor: '#d1fae5',
                    color: '#065f46',
                    border: 'none',
                    borderRadius: '6px',
                    fontSize: '12px',
                    fontWeight: '600',
                    cursor: approvingId === request.id ? 'not-allowed' : 'pointer',
                    opacity: approvingId === request.id ? 0.6 : 1,
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    if (approvingId !== request.id) {
                      (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#a7f3d0';
                    }
                  }}
                  onMouseLeave={(e) => {
                    (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#d1fae5';
                  }}
                >
                  {approvingId === request.id ? 'Approving...' : 'Approve'}
                </button>
              </div>
            </div>
          ))}
        </div>
      );
    };
    const [profileStats, setProfileStats] = useState({
      totalDatasets: 0,
      totalFiles: 0,
      totalEarnings: 0,
      apiConnections: 0,
    });

    // Load user profile data
    useEffect(() => {
      const loadProfileData = async () => {
        if (!isAuthenticated || !currentUser) return;
        
        try {
          const userId = getUserId();
          const userDocRef = doc(db, 'users', userId);
          
          // Get user profile
          const userDoc = await getDocs(collection(userDocRef, 'profile'));
          if (!userDoc.empty) {
            const profileData = userDoc.docs[0].data();
            setUserProfile(profileData);
          }

          // Get stats
          const datasets = await getDatasets(userId);
          const walletRef = collection(userDocRef, 'wallet');
          const walletSnapshot = await getDocs(walletRef);
          
          let totalFiles = 0;
          walletSnapshot.forEach((folderDoc: any) => {
            const folderData = folderDoc.data();
            totalFiles += folderData.fileCount || 0;
          });

          const aiLabsRef = collection(userDocRef, 'aiLabConnections');
          const aiLabsSnapshot = await getDocs(aiLabsRef);

          setProfileStats({
            totalDatasets: datasets.length,
            totalFiles,
            totalEarnings: datasets.reduce((sum, d) => sum + d.earnings.monthlyRevenue, 0),
            apiConnections: aiLabsSnapshot.size,
          });
        } catch (error) {
          console.error('Error loading profile data:', error);
        }
      };

      if (open) {
        loadProfileData();
        setEditName(currentUser?.displayName || '');
        setEditEmail(currentUser?.email || '');
      }
    }, [open, currentUser, isAuthenticated]);

    const handleSaveProfile = async () => {
      if (!isAuthenticated || !currentUser) return;
      
      try {
        const userId = getUserId();
        const userDocRef = doc(db, 'users', userId);
        
        await setDoc(userDocRef, {
          displayName: editName,
          email: editEmail,
          updatedAt: new Date().toISOString(),
        }, { merge: true });

        // Update Firebase Auth profile
        await updateProfile(currentUser, {
          displayName: editName,
        });

        setIsEditing(false);
        alert('Profile updated successfully!');
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile');
      }
    };

    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0, 0, 0, 0.5)',
        zIndex: 2000,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px'
      }}
      onClick={onClose}
      >
        <div style={{
          backgroundColor: currentTheme.cardBg,
          borderRadius: '20px',
          width: '100%',
          maxWidth: '800px',
          maxHeight: '90vh',
          boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden'
        }}
        onClick={(e) => e.stopPropagation()}
        >
          {/* Header */}
          <div style={{
            padding: '24px 32px',
            borderBottom: `1px solid ${currentTheme.border}`,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between'
          }}>
            <h2 style={{
              fontSize: '24px',
              fontWeight: '700',
              color: currentTheme.text,
              margin: 0
            }}>
              Profile & Settings
            </h2>
            <button
              onClick={onClose}
              style={{
                background: 'none',
                border: 'none',
                color: currentTheme.textSecondary,
                fontSize: '24px',
                cursor: 'pointer',
                padding: '4px',
                borderRadius: '4px',
                transition: 'all 0.2s'
              }}
              onMouseEnter={(e) => {
                (e.currentTarget as HTMLButtonElement).style.color = currentTheme.text;
                (e.currentTarget as HTMLButtonElement).style.backgroundColor = currentTheme.borderLight;
              }}
              onMouseLeave={(e) => {
                (e.currentTarget as HTMLButtonElement).style.color = currentTheme.textSecondary;
                (e.currentTarget as HTMLButtonElement).style.backgroundColor = 'transparent';
              }}
            >
              <X style={{ width: '20px', height: '20px' }} />
            </button>
          </div>

          {/* Tabs */}
          <div style={{
            display: 'flex',
            borderBottom: `1px solid ${currentTheme.border}`,
            padding: '0 32px',
            gap: '8px'
          }}>
            {[
              { id: 'profile', label: 'Profile', icon: User },
              { id: 'settings', label: 'Settings', icon: Settings },
              { id: 'requests', label: 'Access Requests', icon: FileText },
              { id: 'security', label: 'Security', icon:  Zap },
              { id: 'billing', label: 'Billing', icon: DollarSign },
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                style={{
                  padding: '12px 20px',
                  border: 'none',
                  background: 'none',
                  borderBottom: `2px solid ${activeTab === tab.id ? '#3b82f6' : 'transparent'}`,
                  color: activeTab === tab.id ? '#3b82f6' : currentTheme.textSecondary,
                  cursor: 'pointer',
                  fontWeight: activeTab === tab.id ? '600' : '500',
                  fontSize: '14px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  transition: 'all 0.2s'
                }}
              >
                <tab.icon style={{ width: '16px', height: '16px' }} />
                {tab.label}
              </button>
            ))}
          </div>

          {/* Content */}
          <div style={{
            flex: 1,
            padding: '32px',
            overflowY: 'auto'
          }}>
            {activeTab === 'profile' && (
              <div>
                {/* Profile Header */}
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '24px',
                  marginBottom: '32px',
                  paddingBottom: '24px',
                  borderBottom: `1px solid ${currentTheme.border}`
                }}>
                  <div style={{
                    width: '80px',
                    height: '80px',
                    borderRadius: '50%',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                    fontSize: '32px',
                    fontWeight: '700'
                  }}>
                    {currentUser?.displayName?.charAt(0).toUpperCase() || 'U'}
                  </div>
                  <div style={{ flex: 1 }}>
                    {isEditing ? (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        <input
                          type="text"
                          value={editName}
                          onChange={(e) => setEditName(e.target.value)}
                          placeholder="Display Name"
                          style={{
                            padding: '10px 16px',
                            border: `1px solid ${currentTheme.border}`,
                            borderRadius: '8px',
                            fontSize: '16px',
                            backgroundColor: currentTheme.cardBg,
                            color: currentTheme.text
                          }}
                        />
                        <input
                          type="email"
                          value={editEmail}
                          onChange={(e) => setEditEmail(e.target.value)}
                          placeholder="Email"
                          style={{
                            padding: '10px 16px',
                            border: `1px solid ${currentTheme.border}`,
                            borderRadius: '8px',
                            fontSize: '16px',
                            backgroundColor: currentTheme.cardBg,
                            color: currentTheme.text
                          }}
                        />
                        <div style={{ display: 'flex', gap: '8px' }}>
                          <button
                            onClick={handleSaveProfile}
                            style={{
                              padding: '8px 16px',
                              backgroundColor: '#3b82f6',
                              color: 'white',
                              border: 'none',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontWeight: '600'
                            }}
                          >
                            Save
                          </button>
                          <button
                            onClick={() => {
                              setIsEditing(false);
                              setEditName(currentUser?.displayName || '');
                              setEditEmail(currentUser?.email || '');
                            }}
                            style={{
                              padding: '8px 16px',
                              backgroundColor: currentTheme.borderLight,
                              color: currentTheme.text,
                              border: 'none',
                              borderRadius: '8px',
                              cursor: 'pointer'
                            }}
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    ) : (
                      <>
                        <h3 style={{
                          fontSize: '24px',
                          fontWeight: '700',
                          color: currentTheme.text,
                          margin: '0 0 8px 0'
                        }}>
                          {currentUser?.displayName || 'User'}
                        </h3>
                        <p style={{
                          fontSize: '14px',
                          color: currentTheme.textSecondary,
                          margin: '0 0 16px 0'
                        }}>
                          {currentUser?.email || 'No email'}
                        </p>
                        <button
                          onClick={() => setIsEditing(true)}
                          style={{
                            padding: '8px 16px',
                            backgroundColor: currentTheme.borderLight,
                            color: currentTheme.text,
                            border: `1px solid ${currentTheme.border}`,
                            borderRadius: '8px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500'
                          }}
                        >
                          Edit Profile
                        </button>
                      </>
                    )}
                  </div>
                </div>

                {/* Stats Grid */}
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(2, 1fr)',
                  gap: '16px',
                  marginBottom: '32px'
                }}>
                  {[
                    { label: 'Total Datasets', value: profileStats.totalDatasets, icon: Database, color: '#3b82f6' },
                    { label: 'Total Files', value: profileStats.totalFiles, icon: File, color: '#10b981' },
                    { label: 'Monthly Earnings', value: `$${profileStats.totalEarnings.toFixed(2)}`, icon: DollarSign, color: '#f59e0b' },
                    { label: 'API Connections', value: profileStats.apiConnections, icon: Code, color: '#8b5cf6' },
                  ].map((stat, idx) => (
                    <div
                      key={idx}
                      style={{
                        backgroundColor: currentTheme.activityBg,
                        padding: '20px',
                        borderRadius: '12px',
                        border: `1px solid ${currentTheme.borderLight}`
                      }}
                    >
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        marginBottom: '8px'
                      }}>
                        <div style={{
                          width: '40px',
                          height: '40px',
                          borderRadius: '8px',
                          backgroundColor: `${stat.color}20`,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: stat.color
                        }}>
                          <stat.icon style={{ width: '20px', height: '20px' }} />
                        </div>
                        <div>
                          <div style={{
                            fontSize: '24px',
                            fontWeight: '700',
                            color: currentTheme.text
                          }}>
                            {stat.value}
                          </div>
                          <div style={{
                            fontSize: '12px',
                            color: currentTheme.textSecondary
                          }}>
                            {stat.label}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Account Info */}
                <div style={{
                  backgroundColor: currentTheme.activityBg,
                  padding: '20px',
                  borderRadius: '12px',
                  marginBottom: '24px'
                }}>
                  <h4 style={{
                    fontSize: '16px',
                    fontWeight: '600',
                    color: currentTheme.text,
                    margin: '0 0 16px 0'
                  }}>
                    Account Information
                  </h4>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ color: currentTheme.textSecondary }}>User ID:</span>
                      <span style={{ color: currentTheme.text, fontFamily: 'monospace', fontSize: '12px' }}>
                        {currentUser?.uid?.substring(0, 8)}...
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ color: currentTheme.textSecondary }}>Member Since:</span>
                      <span style={{ color: currentTheme.text }}>
                        {currentUser?.metadata?.creationTime ? 
                          new Date(currentUser.metadata.creationTime).toLocaleDateString() : 
                          'N/A'}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ color: currentTheme.textSecondary }}>Account Type:</span>
                      <span style={{ 
                        color: '#10b981',
                        fontWeight: '600',
                        backgroundColor: '#10b98120',
                        padding: '4px 8px',
                        borderRadius: '4px',
                        fontSize: '12px'
                      }}>
                        Premium
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'settings' && (
              <div>
                <h3 style={{
                  fontSize: '20px',
                  fontWeight: '600',
                  color: currentTheme.text,
                  margin: '0 0 24px 0'
                }}>
                  Preferences
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                  <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '16px',
                    backgroundColor: currentTheme.activityBg,
                    borderRadius: '8px'
                  }}>
                    <div>
                      <div style={{ fontWeight: '600', color: currentTheme.text, marginBottom: '4px' }}>
                        Dark Mode
                      </div>
                      <div style={{ fontSize: '12px', color: currentTheme.textSecondary }}>
                        Toggle dark/light theme
                      </div>
                    </div>
                    <button
                      onClick={() => setIsDarkMode(!isDarkMode)}
                      style={{
                        width: '48px',
                        height: '24px',
                        borderRadius: '12px',
                        border: 'none',
                        backgroundColor: isDarkMode ? '#3b82f6' : currentTheme.border,
                        cursor: 'pointer',
                        position: 'relative',
                        transition: 'all 0.2s'
                      }}
                    >
                      <div style={{
                        width: '20px',
                        height: '20px',
                        borderRadius: '50%',
                        backgroundColor: 'white',
                        position: 'absolute',
                        top: '2px',
                        left: isDarkMode ? '26px' : '2px',
                        transition: 'left 0.2s'
                      }} />
                    </button>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'requests' && (
              <div>
                <h3 style={{
                  fontSize: '20px',
                  fontWeight: '600',
                  color: currentTheme.text,
                  margin: '0 0 24px 0'
                }}>
                  ðŸ“‹ Dataset Access Requests
                </h3>
                
                {/* Access Requests List - Component removed for debugging */}
                <div style={{
                  padding: '20px',
                  backgroundColor: currentTheme.cardBg,
                  borderRadius: '8px',
                  textAlign: 'center',
                  color: currentTheme.textSecondary
                }}>
                  Access Requests functionality coming soon
                </div>
              </div>
            )}

            {activeTab === 'security' && (
              <div>
                <h3 style={{
                  fontSize: '20px',
                  fontWeight: '600',
                  color: currentTheme.text,
                  margin: '0 0 24px 0'
                }}>
                  Security Settings
                </h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                  <div style={{
                    padding: '16px',
                    backgroundColor: currentTheme.activityBg,
                    borderRadius: '8px'
                  }}>
                    <div style={{ fontWeight: '600', color: currentTheme.text, marginBottom: '8px' }}>
                      Connected Accounts
                    </div>
                    <div style={{ fontSize: '12px', color: currentTheme.textSecondary, marginBottom: '12px' }}>
                      Manage your connected authentication providers
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                      {currentUser?.providerData?.map((provider: any, idx: number) => (
                        <div key={idx} style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          padding: '12px',
                          backgroundColor: currentTheme.cardBg,
                          borderRadius: '6px'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            {provider.providerId === 'google.com' && <span>ðŸ”µ</span>}
                            {provider.providerId === 'github.com' && <Github style={{ width: '16px', height: '16px' }} />}
                            <span style={{ color: currentTheme.text, fontSize: '14px' }}>
                              {provider.providerId === 'google.com' ? 'Google' : 
                               provider.providerId === 'github.com' ? 'GitHub' : 
                               provider.providerId}
                            </span>
                          </div>
                          <span style={{
                            color: '#10b981',
                            fontSize: '12px',
                            fontWeight: '600'
                          }}>
                            Connected
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'billing' && (
              <div>
                <h3 style={{
                  fontSize: '20px',
                  fontWeight: '600',
                  color: currentTheme.text,
                  margin: '0 0 24px 0'
                }}>
                  Billing & Subscription
                </h3>
                <div style={{
                  padding: '24px',
                  backgroundColor: currentTheme.activityBg,
                  borderRadius: '12px',
                  border: `2px solid #3b82f6`
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px' }}>
                    <DollarSign style={{ width: '24px', height: '24px', color: '#3b82f6' }} />
                    <div>
                      <div style={{ fontWeight: '600', color: currentTheme.text, fontSize: '18px' }}>
                        Premium Plan
                      </div>
                      <div style={{ fontSize: '12px', color: currentTheme.textSecondary }}>
                        Active subscription
                      </div>
                    </div>
                  </div>
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: '1fr 1fr',
                    gap: '16px',
                    marginTop: '20px'
                  }}>
                    <div>
                      <div style={{ fontSize: '12px', color: currentTheme.textSecondary, marginBottom: '4px' }}>
                        Monthly Earnings
                      </div>
                      <div style={{ fontSize: '20px', fontWeight: '700', color: currentTheme.text }}>
                        ${profileStats.totalEarnings.toFixed(2)}
                      </div>
                    </div>
                    <div>
                      <div style={{ fontSize: '12px', color: currentTheme.textSecondary, marginBottom: '4px' }}>
                        Next Payment
                      </div>
                      <div style={{ fontSize: '20px', fontWeight: '700', color: currentTheme.text }}>
                        Free
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  const SourcePickerModal = ({ open, onClose }: { open: boolean; onClose: () => void }) => {
    if (!open) return null;
    
    return (
      <div
        style={{
          position: 'fixed',
          top: 0, left: 0, width: '100vw', height: '100vh',
          background: 'rgba(0,0,0,0.5)',
          zIndex: 2000,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }}
        onClick={onClose}
      >
        <div
          style={{
            background: currentTheme.cardBg,
            color: currentTheme.text,
            borderRadius: 16,
            minWidth: 400,
            maxWidth: 500,
            width: '90%',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
            padding: 32,
            position: 'relative',
            maxHeight: '80vh',
            overflowY: 'auto'
          }}
          onClick={e => e.stopPropagation()}
        >
          <button
            onClick={onClose}
            style={{
              position: 'absolute',
              top: 16,
              right: 16,
              background: 'none',
              border: 'none',
              color: currentTheme.textSecondary,
              fontSize: 24,
              cursor: 'pointer',
              padding: 4,
              borderRadius: 4,
              transition: 'color 0.2s'
            }}
            onMouseEnter={(e: React.MouseEvent<HTMLButtonElement>) => {
              (e.currentTarget as HTMLButtonElement).style.color = currentTheme.text;
            }}
            onMouseLeave={(e: React.MouseEvent<HTMLButtonElement>) => {
              (e.currentTarget as HTMLButtonElement).style.color = currentTheme.textSecondary;
            }}
          >
            <X style={{ width: 20, height: 20 }} />
          </button>
          
          <h2 style={{ 
            marginTop: 0, 
            marginBottom: 24, 
            fontSize: 24, 
            fontWeight: 700,
            color: currentTheme.text 
          }}>
            Add Data Source
          </h2>
          
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
            {sourceOptions.map((option, index) => (
              <button
                key={option.name}
                onClick={() => option.onClick(onClose)}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '16px',
                  width: '100%',
                  background: isDarkMode ? '#232946' : '#f8fafc',
                  color: currentTheme.text,
                  border: `1px solid ${currentTheme.borderLight}`,
                  borderRadius: 12,
                  padding: '16px 20px',
                  fontSize: 16,
                  fontWeight: 500,
                  cursor: 'pointer',
                  transition: 'all 0.2s',
                  textAlign: 'left'
                }}
                onMouseEnter={e => {
                  (e.currentTarget as HTMLButtonElement).style.background = isDarkMode ? '#312e81' : '#e0e7ff';
                  (e.currentTarget as HTMLButtonElement).style.borderColor = '#6366f1';
                  (e.currentTarget as HTMLButtonElement).style.transform = 'translateY(-2px)';
                  (e.currentTarget as HTMLButtonElement).style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
                }}
                onMouseLeave={e => {
                  (e.currentTarget as HTMLButtonElement).style.background = isDarkMode ? '#232946' : '#f8fafc';
                  (e.currentTarget as HTMLButtonElement).style.borderColor = currentTheme.borderLight;
                  (e.currentTarget as HTMLButtonElement).style.transform = 'translateY(0)';
                  (e.currentTarget as HTMLButtonElement).style.boxShadow = 'none';
                }}
              >
                <div style={{
                  fontSize: 24,
                  width: 40,
                  height: 40,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  backgroundColor: isDarkMode ? '#1e293b' : 'white',
                  borderRadius: 8,
                  border: `1px solid ${currentTheme.borderLight}`
                }}>
                  {option.icon}
                </div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontWeight: 600, marginBottom: 4 }}>{option.name}</div>
                  <div style={{ fontSize: 14, color: currentTheme.textSecondary, lineHeight: 1.4 }}>
                    {option.description}
                  </div>
                </div>
              </button>
            ))}
          </div>
          
          {uploadedFiles.length > 0 && (
            <div style={{ marginTop: 24, paddingTop: 24, borderTop: `1px solid ${currentTheme.borderLight}` }}>
              <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 12, color: currentTheme.text }}>
                Recently Uploaded ({uploadedFiles.length})
              </h3>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 8, maxHeight: 120, overflowY: 'auto' }}>
                {uploadedFiles.slice(0, 3).map((file, index) => (
                  <div
                    key={index}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: 12,
                      padding: '8px 12px',
                      backgroundColor: currentTheme.activityBg,
                      borderRadius: 8,
                      fontSize: '13px'
                    }}
                  >
                    <File style={{ width: 16, height: 16, color: currentTheme.textSecondary }} />
                    <span style={{ flex: 1, fontWeight: 500 }}>{file.name}</span>
                    <span style={{ color: currentTheme.textSecondary }}>
                      {(file.size / 1024).toFixed(1)} KB
                    </span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  // Calculate stats from Firestore data
  const [statsFromFirestore, setStatsFromFirestore] = useState({
    totalUploadedBytes: 0,
    totalFiles: 0,
    totalFolders: 0,
    totalDataSources: 0
  });

  useEffect(() => {
    const calculateStatsFromFirestore = async () => {
      if (!isAuthenticated || !currentUser) return;
      try {
        const userId = getUserId();
        const userDocRef = doc(db, 'users', userId);
        
        // Calculate from wallet collection
        const walletRef = collection(userDocRef, 'wallet');
        const walletSnapshot = await getDocs(walletRef);
        
        let totalBytes = 0;
        let totalFiles = 0;
        let totalFolders = 0;
        
        walletSnapshot.forEach((folderDoc: any) => {
          const folderData = folderDoc.data();
          totalFolders++;
          
          // Use totalSize if available, otherwise calculate from files array
          if (folderData.totalSize) {
            totalBytes += folderData.totalSize;
            totalFiles += folderData.fileCount || 0;
          } else if (folderData.files && Array.isArray(folderData.files)) {
            folderData.files.forEach((file: any) => {
              totalFiles++;
              totalBytes += file.size || 0;
            });
          }
        });
        
        // Get data sources count
        const dataSourcesRef = collection(userDocRef, 'dataSources');
        const dataSourcesSnapshot = await getDocs(dataSourcesRef);
        const totalDataSources = dataSourcesSnapshot.size;
        
        setStatsFromFirestore({
          totalUploadedBytes: totalBytes,
          totalFiles: totalFiles,
          totalFolders: totalFolders,
          totalDataSources: totalDataSources
        });
        
        console.log(`âœ… Stats calculated from Firestore:`, {
          totalBytes: formatBytes(totalBytes),
          totalFiles,
          totalFolders,
          totalDataSources
        });
      } catch (error) {
        console.error('âŒ Error calculating stats from Firestore:', error);
      }
    };

    if (isAuthenticated && currentUser) {
      calculateStatsFromFirestore();
    }
  }, [isAuthenticated, currentUser, uploadedFiles, dataSources, walletFolders]);

  // Calculate total uploaded bytes - use Firestore stats if available, otherwise use local state
  const totalUploadedBytes = statsFromFirestore.totalUploadedBytes > 0 
    ? statsFromFirestore.totalUploadedBytes 
    : uploadedFiles.reduce((acc, file) => acc + (file.size || 0), 0);

  return (
    <div>
      {/* Google Sign-in Modal */}
      <GoogleSignInModal />

      {/* Scrollbar Styles */}
      <style>{`
        /* Scrollbar styling for sidebar */
        div[style*="height: 100vh"][style*="overflowY"]::-webkit-scrollbar {
          width: 8px;
        }
        
        div[style*="height: 100vh"][style*="overflowY"]::-webkit-scrollbar-track {
          background: transparent;
        }
        
        div[style*="height: 100vh"][style*="overflowY"]::-webkit-scrollbar-thumb {
          background: ${isDarkMode ? '#475569' : '#cbd5e1'};
          border-radius: 4px;
        }
        
        div[style*="height: 100vh"][style*="overflowY"]::-webkit-scrollbar-thumb:hover {
          background: ${isDarkMode ? '#64748b' : '#94a3b8'};
        }
      `}</style>
      {isAuthenticated && (
        <>
          {/* AI Labs API Modal */}
          <AILabsModal
            open={showAILabsModal}
            onClose={() => {
              setShowAILabsModal(false);
            }}
          />

      {/* Profile Modal with Access Requests Tab */}
      <ProfileModal 
        open={showProfileModal} 
        onClose={() => setShowProfileModal(false)} 
      />
      
      <div style={{
          display: 'flex',
          height: '100vh',
          backgroundColor: currentTheme.bg,
          fontFamily: 'system-ui, -apple-system, sans-serif',
          overflow: 'hidden',
          transition: 'background-color 0.3s ease'
        }}>
      {/* Sidebar */}
      <div style={{
        width: '280px',
        backgroundColor: currentTheme.sidebarBg,
        boxShadow: '0 1px 3px 0 rgb(0 0 0 / 0.1)',
        borderRight: `1px solid ${currentTheme.border}`,
        transition: 'all 0.3s ease',
        display: isMobile ? 'none' : 'block',
        height: '100vh',
        overflowY: 'auto',
        overflowX: 'hidden'
      }}>
        <div style={{
          padding: '24px',
          display: 'flex',
          alignItems: 'center',
          gap: '12px',
          borderBottom: `1px solid ${currentTheme.borderLight}`
        }}>
          <div style={{
            width: '40px',
            height: '40px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '12px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            color: 'white',
            fontSize: '16px',
            fontWeight: 'bold',
            boxShadow: '0 4px 12px rgba(102, 126, 234, 0.4)'
          }}>
            D
          </div>
          <div>
            <div style={{ fontWeight: '700', fontSize: '18px', color: currentTheme.text }}>DATTA STUDIO</div>
            <div style={{ fontSize: '12px', color: currentTheme.textSecondary }}>Data Intelligence Platform</div>
          </div>
        </div>
       
        <nav style={{ marginTop: '24px', padding: '0 16px' }}>
          {sidebarItems.map((item, index) => {
            const isActive = (item.label === 'Dashboard' && activeView === 'dashboard') || 
                           (item.label === 'Annotation Services' && activeView === 'annotations');
            
            return (
            <a
              key={index}
              href="#"
              onMouseEnter={() => setHoveredSidebar(index)}
              onMouseLeave={() => setHoveredSidebar(null)}
              onClick={(e) => {
                  e.preventDefault();
                  if (item.label === 'Annotation Services') {
                    setActiveView('annotations');
                  } else if (item.label === 'Dashboard') {
                    setActiveView('dashboard');
                  } else if (item.label === 'AI Datasets') {
                    window.location.href = '/discover';
                  }
              }}
              style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '14px 16px',
                fontSize: '14px',
                fontWeight: '500',
                textDecoration: 'none',
                borderRadius: '12px',
                margin: '4px 0',
                transition: 'all 0.2s ease',
                  color: isActive
                  ? '#3b82f6'
                  : hoveredSidebar === index
                  ? isDarkMode
                    ? '#a5b4fc'
                    : '#1e40af'
                  : currentTheme.textSecondary,
                  backgroundColor: isActive
                  ? (isDarkMode ? '#1e40af20' : '#eff6ff')
                  : hoveredSidebar === index
                  ? isDarkMode ? '#312e81' : '#e0e7ff'
                  : 'transparent',
                  boxShadow: isActive
                  ? '0 2px 4px rgba(59, 130, 246, 0.1)'
                  : hoveredSidebar === index
                  ? '0 2px 8px rgba(59, 130, 246, 0.08)'
                  : undefined,
                  transform: isActive
                  ? 'translateX(4px)'
                  : hoveredSidebar === index
                  ? 'translateX(2px)'
                  : undefined,
                cursor: 'pointer'
              }}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <item.icon style={{ width: '20px', height: '20px' }} />
                {item.label}
              </div>
              {item.badge && (
                <span style={{
                  backgroundColor: item.badge === 'New' ? '#f59e0b' : '#3b82f6',
                  color: 'white',
                  fontSize: '10px',
                  padding: '2px 6px',
                  borderRadius: '10px',
                  fontWeight: '600'
                }}>
                  {item.badge}
                </span>
              )}
            </a>
            );
          })}
        </nav>

        {/* Pro Plan Upgrade Section */}
        <div
          style={{
            margin: '32px 16px 0 16px',
            padding: '20px',
            background: isDarkMode
              ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
              : 'linear-gradient(135deg, #3b82f6 0%, #6366f1 100%)',
            borderRadius: '14px',
            color: '#fff',
            textAlign: 'center',
            boxShadow: isDarkMode
              ? '0 4px 16px rgba(102,126,234,0.15)'
              : '0 4px 16px rgba(59,130,246,0.15)'
          }}
        >
          <span style={{ fontWeight: 700, fontSize: '16px', display: 'block', marginBottom: '8px' }}>
            Upgrade to Pro
          </span>
          <span style={{ fontSize: '13px', opacity: 0.95, display: 'block', marginBottom: '16px' }}>
            Unlock advanced analytics, priority support, and more.
          </span>
          <button
            style={{
              background: '#fff',
              color: isDarkMode ? '#667eea' : '#3b82f6',
              border: 'none',
              borderRadius: '8px',
              padding: '8px 18px',
              fontWeight: 600,
              fontSize: '14px',
              cursor: 'pointer',
              transition: 'all 0.2s'
            }}
          >
            Upgrade Now
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div style={{ flex: 1, overflow: 'auto', paddingBottom: '60px' }}>
        {activeView === 'annotations' ? (
          <AnnotationDashboard isDarkMode={isDarkMode} onBack={() => setActiveView('dashboard')} />
        ) : (
          <>
        {/* Header */}
        <header style={{
          backgroundColor: currentTheme.cardBg,
          borderBottom: `1px solid ${currentTheme.border}`,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: isMobile ? '12px 16px' : '16px 32px',
          position: 'sticky',
          top: 0,
          zIndex: 10
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '24px' }}>
            <h1 style={{ fontSize: '28px', fontWeight: '700', color: currentTheme.text, margin: 0 }}>
              Dashboard
            </h1>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              {['1M', '3M', '6M', '1Y'].map((period) => (
                <button
                  key={period}
                  onClick={() => setSelectedTimeframe(period)}
                  style={{
                    padding: '6px 12px',
                    fontSize: '12px',
                    fontWeight: '500',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    transition: 'all 0.2s',
                    backgroundColor: selectedTimeframe === period ? '#3b82f6' : currentTheme.activityBg,
                    color: selectedTimeframe === period ? 'white' : currentTheme.textSecondary
                  }}
                >
                  {period}
                </button>
              ))}
            </div>
          </div>
         
          <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
            <div style={{ position: 'relative' }}>
              <Search style={{
                position: 'absolute',
                left: '12px',
                top: '50%',
                transform: 'translateY(-50%)', 
                width: '16px',
                height: '16px',
                color: currentTheme.textSecondary
              }} />
              <input
                type="text"
                placeholder="Search..."
                style={{
                  paddingLeft: '36px',
                  paddingRight: '12px',
                  paddingTop: '8px',
                  paddingBottom: '8px',
                  border: `1px solid ${currentTheme.border}`,
                  borderRadius: '8px',
                  fontSize: '14px',
                  backgroundColor: currentTheme.searchBg,
                  width: '200px',
                  color: currentTheme.text
                }}
              />
            </div>

            <button onClick={toggleTheme} style={{
              padding: '8px',
              borderRadius: '8px',
              border: `1px solid ${currentTheme.border}`,
              backgroundColor: currentTheme.cardBg,
              cursor: 'pointer'
            }}>
              {isDarkMode ? (
                <Sun style={{ width: '18px', height: '18px', color: '#f59e0b' }} />
              ) : (
                <Moon style={{ width: '18px', height: '18px', color: currentTheme.textSecondary }} />
                    )}
            </button>

            {!isAuthenticated ? (
              <button
                onClick={() => setShowAuthModal(true)}
                style={{
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: 'none',
                  backgroundColor: '#3b82f6',
                  color: 'white',
                  cursor: 'pointer',
                  fontSize: '13px',
                  fontWeight: '600',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#2563eb';
                  e.currentTarget.style.transform = 'translateY(-2px)';
                  e.currentTarget.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = '#3b82f6';
                  e.currentTarget.style.transform = 'translateY(0)';
                  e.currentTarget.style.boxShadow = 'none';
                }}
              >
                Sign Up
              </button>
            ) : (
              <button
                onClick={() => setShowAILabsModal(true)}
                style={{
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: 'none',
                  backgroundColor: '#7c3aed',
                  color: 'white',
                  cursor: 'pointer',
                  fontSize: '13px',
                  fontWeight: '500',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#a78bfa';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = '#7c3aed';
                }}
                title="Connect AI Labs to access your datasets"
              >
                <Code style={{ width: '16px', height: '16px' }} />
                AI Labs API
              </button>
            )}
           
            <div style={{ display: isAuthenticated ? 'flex' : 'none', alignItems: 'center', gap: '16px' }}>
              <div style={{ textAlign: 'right' }}>
                <div style={{ fontSize: '14px', fontWeight: '500', color: currentTheme.text }}>
                  {currentUser?.displayName || 'User'}
                </div>
                <div style={{ fontSize: '12px', color: currentTheme.textSecondary }}>Premium Member</div>
              </div>
              <div 
                onClick={() => setShowProfileModal(true)}
                style={{
                  width: '40px',
                  height: '40px',
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  borderRadius: '50%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  cursor: 'pointer',
                  transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => {
                  (e.currentTarget as HTMLDivElement).style.transform = 'scale(1.1)';
                }}
                onMouseLeave={(e) => {
                  (e.currentTarget as HTMLDivElement).style.transform = 'scale(1)';
                }}
                title="View Profile"
              >
                <User style={{ width: '18px', height: '18px', color: 'white' }} />
              </div>
              <button
                onClick={handleLogout}
                style={{
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: '1px solid #ef4444',
                  backgroundColor: 'transparent',
                  color: '#ef4444',
                  cursor: 'pointer',
                  fontSize: '13px',
                  fontWeight: '600',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#fecaca';
                  e.currentTarget.style.borderColor = '#dc2626';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                  e.currentTarget.style.borderColor = '#ef4444';
                }}
              >
                Logout
              </button>
            </div>
          </div>
        </header>

        {/* Dashboard Content */}
        <main style={{ padding: isMobile ? '20px' : '32px' }}>
          {/* Stats Cards */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: isMobile ? '1fr' : 'repeat(auto-fit, minmax(240px, 1fr))',
            gap: '24px',
            marginBottom: '32px'
          }}>
            {[
              { 
                label: 'Data Uploaded', 
                value: formatBytes(totalUploadedBytes), 
                icon: Database, 
                color: '#3b82f6', 
                trend: statsFromFirestore.totalFiles > 0 ? `+${statsFromFirestore.totalFiles}` : (uploadedFiles.length > 0 ? `+${uploadedFiles.length}` : '') 
              },
              { 
                label: 'Active Sources', 
                value: statsFromFirestore.totalDataSources > 0 ? statsFromFirestore.totalDataSources.toString() : dataSources.length.toString(), 
                icon: Activity, 
                color: '#10b981', 
                trend: statsFromFirestore.totalDataSources > 0 ? `+${statsFromFirestore.totalDataSources}` : `+${dataSources.length}` 
              },
              { label: 'Total Earnings', value: `$${estimatedEarnings.toFixed(2)}`, icon: DollarSign, color: '#f59e0b', trend: estimatedEarnings > 0 ? '+15%' : '0%' },
              { label: 'Companies', value: '8', icon: TrendingUp, color: '#8b5cf6', trend: '+1' },
              {
                label: 'Data Wallet',
                value: statsFromFirestore.totalFolders > 0 
                  ? `${statsFromFirestore.totalFolders} folders` 
                  : `${walletFolders.length} folders`,
                icon: Folder,
                color: '#6366f1',
                trend: statsFromFirestore.totalFolders > 0 
                  ? `+${statsFromFirestore.totalFolders}` 
                  : `+${walletFolders.length}`
              }
            ].map((stat, index) => (
              <div
                key={index}
                onMouseEnter={() => setHoveredCard(index)}
                onMouseLeave={() => setHoveredCard(null)}
                onClick={() => stat.label === 'Data Wallet' && handleViewWallet()}
                style={{
                  backgroundColor: currentTheme.cardBg,
                  padding: '24px',
                  borderRadius: '16px',
                  boxShadow: hoveredCard === index ? '0 8px 25px rgba(0, 0, 0, 0.1)' : '0 2px 8px rgba(0, 0, 0, 0.04)',
                  border: `1px solid ${currentTheme.borderLight}`,
                  transition: 'all 0.3s ease',
                  transform: hoveredCard === index ? 'translateY(-4px) scale(1.02)' : 'translateY(0) scale(1)',
                  cursor: stat.label === 'Data Wallet' ? 'pointer' : 'default'
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                  <div style={{
                    padding: '12px',
                    borderRadius: '12px',
                    backgroundColor: `${stat.color}15`,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <stat.icon style={{ width: '24px', height: '24px', color: stat.color }} />
                  </div>
                  <span style={{
                    fontSize: '12px',
                    fontWeight: '600',
                    color: stat.color,
                    backgroundColor: `${stat.color}15`,
                    padding: '4px 8px',
                    borderRadius: '6px'
                  }}>
                    {stat.trend}
                  </span>
                </div>
                <div style={{ fontSize: '14px', fontWeight: '500', color: currentTheme.textSecondary, marginBottom: '8px' }}>
                  {stat.label}
                </div>
                <div style={{ fontSize: '28px', fontWeight: '700', color: currentTheme.text }}>
                  {stat.value}
                </div>
              </div>
            ))}
          </div>

          {/* Insert Data Upload Card here */}
          {/* <DataUploadCard /> */}

          {/* Main Grid */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: isMobile ? '1fr' : '2fr 1fr',
            gap: isMobile ? '20px' : '32px'
          }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              {/* Earnings Chart */}
              <div style={{
                backgroundColor: currentTheme.cardBg,
                padding: '32px',
                borderRadius: '16px',
                boxShadow: '0 2px 8px rgba(0, 0, 0, 0.04)',
                border: `1px solid ${currentTheme.borderLight}`
              }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: '600', color: currentTheme.text, margin: 0 }}>
                    Earnings Overview
                  </h2>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <Zap style={{ width: '16px', height: '16px', color: '#10b981' }} />
                    <span style={{ fontSize: '14px', color: '#10b981', fontWeight: '500' }}>
                      +15% this month
                    </span>
                  </div>
                </div>
                <div style={{ height: '300px' }}>
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={earningsData}>
                      <XAxis
                        dataKey="month"
                        axisLine={false}
                        tickLine={false}
                        tick={{ fontSize: 12, fill: currentTheme.textSecondary }}
                      />
                      <YAxis hide />
                      <Tooltip content={<CustomTooltip />} />
                      <Line
                        type="monotone"
                        dataKey="value"
                        stroke="#3b82f6"
                        strokeWidth={3}
                        dot={{ fill: '#3b82f6', strokeWidth: 2, r: 5 }}
                        activeDot={{ r: 7, fill: '#3b82f6', strokeWidth: 2 }}
                      />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* Data Sources */}
              <div style={{
                backgroundColor: currentTheme.cardBg,
                padding: '24px',
                borderRadius: '16px',
                boxShadow: '0 2px 8px rgba(0, 0, 0, 0.04)',
                border: `1px solid ${currentTheme.borderLight}`
              }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: '600', color: currentTheme.text, margin: 0 }}>
                    Data Sources
                  </h2>
                  <button
                    disabled={isConnecting}
                    style={{
                      backgroundColor: isConnecting ? '#9ca3af' : (hoveredButton === 'add-source' ? '#2563eb' : '#3b82f6'),
                      color: 'white',
                      padding: '10px 16px',
                      borderRadius: '8px',
                      border: 'none',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      cursor: isConnecting ? 'not-allowed' : 'pointer',
                      fontSize: '14px',
                      fontWeight: '500',
                      transition: 'all 0.2s',
                      opacity: isConnecting ? 0.7 : 1
                    }}
                    onMouseEnter={() => !isConnecting && setHoveredButton('add-source')}
                    onMouseLeave={() => setHoveredButton(null)}
                    onClick={() => {
                      if (isConnecting) return;
                      setShowNewAddSourceModal(true);
                    }}
                  >
                    {isConnecting ? (
                      <>
                        <RefreshCw style={{ width: '16px', height: '16px', animation: 'spin 1s linear infinite' }} />
                        <style>{`
                          @keyframes spin {
                            from { transform: rotate(0deg); }
                            to { transform: rotate(360deg); }
                          }
                        `}</style>
                        Connecting...
                      </>
                    ) : (
                      <>
                    <Plus style={{ width: '16px', height: '16px' }} />
                    Add Source
                      </>
                    )}
                  </button>
                </div>
               
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                  {dataSources.length === 0 ? (
                    <div style={{
                      textAlign: 'center',
                      padding: '40px 20px',
                      color: currentTheme.textSecondary,
                      fontSize: '14px'
                    }}>
                      <Upload style={{ width: '48px', height: '48px', margin: '0 auto 16px', opacity: 0.5 }} />
                      <p>No data sources connected yet.</p>
                      <p>Click "Add Source" to get started!</p>
                    </div>
                  ) : (
                    dataSources.map((source, index) => (
                      <div
                        key={index}
                        onMouseEnter={() => setHoveredDataSource(index)}
                        onMouseLeave={() => setHoveredDataSource(null)}
                        onClick={() => handleActivityClick(source as any)}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          padding: '16px',
                          borderRadius: '12px',
                          backgroundColor: hoveredDataSource === index
                            ? isDarkMode ? '#312e81' : '#e0e7ff'
                            : currentTheme.activityBg,
                          border: `1px solid ${currentTheme.borderLight}`,
                          transition: 'all 0.2s',
                          cursor: 'pointer'
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                          <span style={{ fontSize: '20px' }}>{source.icon}</span>
                          <div>
                            <div style={{ fontWeight: '500', color: currentTheme.text }}>{source.name}</div>
                            <div style={{ fontSize: '12px', color: currentTheme.textSecondary }}>
                              {source.dataSize} â€¢ Last sync: {source.lastSync}
                            </div>
                          </div>
                        </div>
                        <span style={{
                          fontSize: '12px',
                          fontWeight: '500',
                          color: '#10b981',
                          backgroundColor: '#d1fae5',
                          padding: '4px 8px',
                          borderRadius: '6px'
                        }}>
                          {source.status}
                        </span>
                      </div>
                    ))
                  )}
                </div>
                
                {/* Data Sources Note */}
                <div style={{
                  marginTop: '24px',
                  padding: '16px 20px',
                  backgroundColor: isDarkMode ? '#4f46e520' : '#fff7ed',
                  borderRadius: '10px',
                  border: `1px solid ${isDarkMode ? '#6366f1' : '#f59e0b'}`,
                  boxShadow: '0 2px 10px rgba(0,0,0,0.06)',
                  fontSize: '13px',
                  color: isDarkMode ? '#e5e7eb' : '#7c2d12',
                  lineHeight: '1.6',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '10px'
                }}>
                  <span style={{
                    display: 'inline-flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    width: '28px',
                    height: '28px',
                    borderRadius: '50%',
                    backgroundColor: isDarkMode ? '#312e81' : '#ffedd5',
                    color: isDarkMode ? '#c7d2fe' : '#f59e0b',
                    fontWeight: 700
                  }}>âš ï¸</span>
                  <span>
                    <span style={{ fontWeight: 700 }}>Note:</span> Your data or content is permission-based and monetized only when licensed by AI companies.
                  </span>
                </div>
              </div>
            </div>

            {/* Right Column */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              {/* Quick Upload Card */}
              <div style={{
                backgroundColor: currentTheme.cardBg,
                padding: '24px',
                borderRadius: '16px',
                boxShadow: '0 2px 8px rgba(0, 0, 0, 0.04)',
                border: `1px solid ${currentTheme.borderLight}`,
                background: isDarkMode 
                  ? 'linear-gradient(135deg, #1e293b 0%, #334155 100%)'
                  : 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)'
              }}>
                <h2 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '12px', color: currentTheme.text }}>
                  Quick Upload
                </h2>
                <p style={{ marginBottom: '20px', color: currentTheme.textSecondary, fontSize: '14px' }}>
                  Drag and drop code files or click to upload (no Excel, PDF, images, or media)
                </p>
                <button
                  style={{
                    width: '100%',
                    backgroundColor: isUploading ? '#9ca3af' : (hoveredButton === 'quick-upload' ? '#2563eb' : '#3b82f6'),
                    color: 'white',
                    padding: '12px',
                    borderRadius: '8px',
                    border: 'none',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                    cursor: isUploading ? 'not-allowed' : 'pointer',
                    fontSize: '14px',
                    fontWeight: '500',
                    transition: 'all 0.2s',
                    opacity: isUploading ? 0.7 : 1
                  }}
                  disabled={isUploading}
                  onMouseEnter={() => !isUploading && setHoveredButton('quick-upload')}
                  onMouseLeave={() => setHoveredButton(null)}
                  onClick={() => {
                    if (isUploading) return;
                    console.log('ðŸ§ª Testing file upload...');
                    handleFileUpload(() => {}, 'Quick Upload');
                  }}
                >
                  {isUploading ? (
                    <>
                      <RefreshCw style={{ width: '18px', height: '18px', animation: 'spin 1s linear infinite' }} />
                      <style>{`
                        @keyframes spin {
                          from { transform: rotate(0deg); }
                          to { transform: rotate(360deg); }
                        }
                      `}</style>
                      Uploading...
                    </>
                  ) : (
                    <>
                  <Upload style={{ width: '18px', height: '18px' }} />
                      Upload Files
                    </>
                  )}
                </button>
              </div>

              {/* Recent Activity */}
              <div style={{
                backgroundColor: currentTheme.cardBg,
                padding: '24px',
                borderRadius: '16px',
                boxShadow: '0 2px 8px rgba(0, 0, 0, 0.04)',
                border: `1px solid ${currentTheme.borderLight}`
              }}>
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '24px'
                }}>
                  <h2 style={{ fontSize: '20px', fontWeight: '600', color: currentTheme.text, margin: 0 }}>
                    Recent Activity
                  </h2>
                  <RefreshCw
                    style={{
                      width: '20px',
                      height: '20px',
                      color: hoveredButton === 'refresh' ? '#3b82f6' : currentTheme.textSecondary,
                      cursor: 'pointer',
                      transform: isRefreshing ? 'rotate(360deg)' : 'rotate(0deg)',
                      transition: 'transform 0.5s ease, color 0.2s'
                    }}
                    onClick={handleRefresh}
                    onMouseEnter={() => setHoveredButton('refresh')}
                    onMouseLeave={() => setHoveredButton(null)}
                  />
                </div>
               
                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                  {recentActivity.map((activity, index) => (
                    <div
                      key={index}
                      onMouseEnter={() => setHoveredActivity(index)}
                      onMouseLeave={() => setHoveredActivity(null)}
                      onClick={() => handleActivityClick(activity)}
                      style={{
                        display: 'flex',
                        alignItems: 'flex-start',
                        gap: '12px',
                        padding: '12px',
                        borderRadius: '8px',
                        backgroundColor: hoveredActivity === index
                          ? isDarkMode ? '#312e81' : '#e0e7ff'
                          : currentTheme.activityBg,
                        transition: 'all 0.2s',
                        cursor: 'pointer'
                      }}
                    >
                      <div style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: '50%',
                        backgroundColor: currentTheme.cardBg,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '14px',
                        border: `1px solid ${currentTheme.border}`
                      }}>
                        {activity.icon}
                      </div>
                      <div style={{ flex: 1 }}>
                        <p style={{
                          margin: '0 0 4px 0',
                          fontSize: '14px',
                          fontWeight: '500',
                          color: currentTheme.text
                        }}>
                          {activity.action}
                        </p>
                        <span style={{ fontSize: '12px', color: currentTheme.textSecondary }}>
                          {activity.time}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </main>
          </>
        )}
        
        {/* Footer */}
        {activeView === 'dashboard' && (
          <footer style={{
            background: isDarkMode 
              ? 'linear-gradient(to bottom, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98))'
              : 'linear-gradient(to bottom, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 1))',
            borderTop: isDarkMode 
              ? `2px solid rgba(102, 126, 234, 0.3)`
              : `2px solid rgba(102, 126, 234, 0.2)`,
            padding: isMobile ? '40px 20px 28px' : '56px 32px 40px',
            marginTop: '64px',
            position: 'relative',
            boxShadow: isDarkMode 
              ? '0 -4px 24px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05)'
              : '0 -4px 24px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8)'
          }}>
            {/* Decorative gradient overlay */}
            <div style={{
              position: 'absolute',
              top: 0,
              left: 0,
              right: 0,
              height: '1px',
              background: isDarkMode
                ? 'linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.5), transparent)'
                : 'linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent)',
              opacity: 0.6
            }}></div>
            
            <div style={{
              maxWidth: '1400px',
              margin: '0 auto',
              position: 'relative',
              zIndex: 1
            }}>
              {/* Main Footer Content */}
              <div style={{
                display: 'grid',
                gridTemplateColumns: isMobile ? '1fr' : 'repeat(4, 1fr)',
                gap: isMobile ? '32px' : '48px',
                marginBottom: isMobile ? '32px' : '40px'
              }}>
                {/* Brand Section */}
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '16px'
                }}>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px'
                  }}>
                    <div style={{
                      width: '48px',
                      height: '48px',
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      borderRadius: '14px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      color: 'white',
                      fontSize: '20px',
                      fontWeight: 'bold',
                      boxShadow: '0 6px 20px rgba(102, 126, 234, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1) inset',
                      position: 'relative'
                    }}>
                      <div style={{
                        position: 'absolute',
                        inset: '-2px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        borderRadius: '14px',
                        opacity: 0.3,
                        filter: 'blur(8px)',
                        zIndex: -1
                      }}></div>
                      D
                    </div>
                    <div>
                      <div style={{
                        fontWeight: '700',
                        fontSize: '18px',
                        color: currentTheme.text
                      }}>
                        DATTA STUDIO
                      </div>
                      <div style={{
                        fontSize: '12px',
                        color: currentTheme.textSecondary
                      }}>
                        Data Intelligence Platform
                      </div>
                    </div>
                  </div>
                  <p style={{
                    fontSize: '14px',
                    color: currentTheme.textSecondary,
                    lineHeight: '1.6',
                    margin: 0,
                    maxWidth: '280px'
                  }}>
                    The YouTube of AI training data - collect, manage and monetize the data that powers tomorrow's intelligence.
                  </p>
                  {/* Social Links */}
                  <div style={{
                    display: 'flex',
                    gap: '12px',
                    marginTop: '8px'
                  }}>
                    <a
                      href="https://github.com"
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{
                        width: '40px',
                        height: '40px',
                        borderRadius: '10px',
                        backgroundColor: isDarkMode ? 'rgba(102, 126, 234, 0.1)' : 'rgba(102, 126, 234, 0.08)',
                        border: `1.5px solid ${isDarkMode ? 'rgba(102, 126, 234, 0.3)' : 'rgba(102, 126, 234, 0.2)'}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: currentTheme.textSecondary,
                        textDecoration: 'none',
                        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        cursor: 'pointer',
                        boxShadow: '0 2px 8px rgba(0, 0, 0, 0.05)'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#667eea';
                        e.currentTarget.style.color = 'white';
                        e.currentTarget.style.borderColor = '#667eea';
                        e.currentTarget.style.transform = 'translateY(-3px) scale(1.05)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(102, 126, 234, 0.4)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(102, 126, 234, 0.1)' : 'rgba(102, 126, 234, 0.08)';
                        e.currentTarget.style.color = currentTheme.textSecondary;
                        e.currentTarget.style.borderColor = isDarkMode ? 'rgba(102, 126, 234, 0.3)' : 'rgba(102, 126, 234, 0.2)';
                        e.currentTarget.style.transform = 'translateY(0) scale(1)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.05)';
                      }}
                    >
                      <Github style={{ width: '18px', height: '18px' }} />
                    </a>
                    <a
                      href="https://twitter.com"
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{
                        width: '40px',
                        height: '40px',
                        borderRadius: '10px',
                        backgroundColor: isDarkMode ? 'rgba(102, 126, 234, 0.1)' : 'rgba(102, 126, 234, 0.08)',
                        border: `1.5px solid ${isDarkMode ? 'rgba(102, 126, 234, 0.3)' : 'rgba(102, 126, 234, 0.2)'}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: currentTheme.textSecondary,
                        textDecoration: 'none',
                        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        cursor: 'pointer',
                        boxShadow: '0 2px 8px rgba(0, 0, 0, 0.05)'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#667eea';
                        e.currentTarget.style.color = 'white';
                        e.currentTarget.style.borderColor = '#667eea';
                        e.currentTarget.style.transform = 'translateY(-3px) scale(1.05)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(102, 126, 234, 0.4)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(102, 126, 234, 0.1)' : 'rgba(102, 126, 234, 0.08)';
                        e.currentTarget.style.color = currentTheme.textSecondary;
                        e.currentTarget.style.borderColor = isDarkMode ? 'rgba(102, 126, 234, 0.3)' : 'rgba(102, 126, 234, 0.2)';
                        e.currentTarget.style.transform = 'translateY(0) scale(1)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.05)';
                      }}
                    >
                      <Twitter style={{ width: '18px', height: '18px' }} />
                    </a>
                    <a
                      href="https://linkedin.com"
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{
                        width: '40px',
                        height: '40px',
                        borderRadius: '10px',
                        backgroundColor: isDarkMode ? 'rgba(102, 126, 234, 0.1)' : 'rgba(102, 126, 234, 0.08)',
                        border: `1.5px solid ${isDarkMode ? 'rgba(102, 126, 234, 0.3)' : 'rgba(102, 126, 234, 0.2)'}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: currentTheme.textSecondary,
                        textDecoration: 'none',
                        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        cursor: 'pointer',
                        boxShadow: '0 2px 8px rgba(0, 0, 0, 0.05)'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#667eea';
                        e.currentTarget.style.color = 'white';
                        e.currentTarget.style.borderColor = '#667eea';
                        e.currentTarget.style.transform = 'translateY(-3px) scale(1.05)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(102, 126, 234, 0.4)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(102, 126, 234, 0.1)' : 'rgba(102, 126, 234, 0.08)';
                        e.currentTarget.style.color = currentTheme.textSecondary;
                        e.currentTarget.style.borderColor = isDarkMode ? 'rgba(102, 126, 234, 0.3)' : 'rgba(102, 126, 234, 0.2)';
                        e.currentTarget.style.transform = 'translateY(0) scale(1)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.05)';
                      }}
                    >
                      <Linkedin style={{ width: '18px', height: '18px' }} />
                    </a>
                    <a
                      href="mailto:support@dattastudio.com"
                      style={{
                        width: '40px',
                        height: '40px',
                        borderRadius: '10px',
                        backgroundColor: isDarkMode ? 'rgba(102, 126, 234, 0.1)' : 'rgba(102, 126, 234, 0.08)',
                        border: `1.5px solid ${isDarkMode ? 'rgba(239, 68, 68, 0.3)' : 'rgba(239, 68, 68, 0.2)'}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: currentTheme.textSecondary,
                        textDecoration: 'none',
                        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        cursor: 'pointer',
                        boxShadow: '0 2px 8px rgba(0, 0, 0, 0.05)'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#ef4444';
                        e.currentTarget.style.color = 'white';
                        e.currentTarget.style.borderColor = '#ef4444';
                        e.currentTarget.style.transform = 'translateY(-3px) scale(1.05)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(239, 68, 68, 0.4)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.08)';
                        e.currentTarget.style.color = currentTheme.textSecondary;
                        e.currentTarget.style.borderColor = isDarkMode ? 'rgba(239, 68, 68, 0.3)' : 'rgba(239, 68, 68, 0.2)';
                        e.currentTarget.style.transform = 'translateY(0) scale(1)';
                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.05)';
                      }}
                    >
                      <Mail style={{ width: '18px', height: '18px' }} />
                    </a>
                  </div>
                </div>

                {/* Product Links */}
                <div>
                  <h4 style={{
                    fontSize: '14px',
                    fontWeight: '700',
                    color: currentTheme.text,
                    margin: '0 0 20px 0',
                    textTransform: 'uppercase',
                    letterSpacing: '0.8px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <span style={{
                      width: '4px',
                      height: '16px',
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      borderRadius: '2px'
                    }}></span>
                    Product
                  </h4>
                  <ul style={{
                    listStyle: 'none',
                    padding: 0,
                    margin: 0,
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                  }}>
                    {['Features', 'Pricing', 'API Documentation', 'Data Sources', 'Annotation Services'].map((link) => (
                      <li key={link}>
                        <a
                          href="#"
                          style={{
                            fontSize: '14px',
                            color: currentTheme.textSecondary,
                            textDecoration: 'none',
                            transition: 'color 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.color = '#667eea';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.color = currentTheme.textSecondary;
                          }}
                        >
                          {link}
                          <ExternalLink style={{ width: '12px', height: '12px', opacity: 0.5 }} />
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>

                {/* Company Links */}
                <div>
                  <h4 style={{
                    fontSize: '14px',
                    fontWeight: '700',
                    color: currentTheme.text,
                    margin: '0 0 20px 0',
                    textTransform: 'uppercase',
                    letterSpacing: '0.8px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <span style={{
                      width: '4px',
                      height: '16px',
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      borderRadius: '2px'
                    }}></span>
                    Company
                  </h4>
                  <ul style={{
                    listStyle: 'none',
                    padding: 0,
                    margin: 0,
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                  }}>
                    {['About Us', 'Blog', 'Careers', 'Contact', 'Partners'].map((link) => (
                      <li key={link}>
                        <a
                          href="#"
                          style={{
                            fontSize: '14px',
                            color: currentTheme.textSecondary,
                            textDecoration: 'none',
                            transition: 'color 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.color = '#667eea';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.color = currentTheme.textSecondary;
                          }}
                        >
                          {link}
                          <ExternalLink style={{ width: '12px', height: '12px', opacity: 0.5 }} />
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>

                {/* Support & Legal */}
                <div>
                  <h4 style={{
                    fontSize: '14px',
                    fontWeight: '700',
                    color: currentTheme.text,
                    margin: '0 0 20px 0',
                    textTransform: 'uppercase',
                    letterSpacing: '0.8px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <span style={{
                      width: '4px',
                      height: '16px',
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      borderRadius: '2px'
                    }}></span>
                    Support & Legal
                  </h4>
                  <ul style={{
                    listStyle: 'none',
                    padding: 0,
                    margin: 0,
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                  }}>
                    {['Help Center', 'Documentation', 'Terms of Service', 'Privacy Policy', 'Cookie Policy'].map((link) => (
                      <li key={link}>
                        <a
                          href="#"
                          style={{
                            fontSize: '14px',
                            color: currentTheme.textSecondary,
                            textDecoration: 'none',
                            transition: 'color 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.color = '#667eea';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.color = currentTheme.textSecondary;
                          }}
                        >
                          {link}
                          <ExternalLink style={{ width: '12px', height: '12px', opacity: 0.5 }} />
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>

              {/* Bottom Bar */}
              <div style={{
                paddingTop: isMobile ? '32px' : '40px',
                borderTop: isDarkMode 
                  ? `1px solid rgba(102, 126, 234, 0.2)`
                  : `1px solid rgba(102, 126, 234, 0.15)`,
                display: 'flex',
                flexDirection: isMobile ? 'column' : 'row',
                alignItems: isMobile ? 'flex-start' : 'center',
                justifyContent: 'space-between',
                gap: isMobile ? '20px' : '0',
                background: isDarkMode 
                  ? 'linear-gradient(to right, rgba(102, 126, 234, 0.05), transparent, rgba(102, 126, 234, 0.05))'
                  : 'linear-gradient(to right, rgba(102, 126, 234, 0.03), transparent, rgba(102, 126, 234, 0.03))',
                borderRadius: '12px',
                paddingLeft: isMobile ? '16px' : '24px',
                paddingRight: isMobile ? '16px' : '24px',
                paddingBottom: isMobile ? '24px' : '32px',
                marginTop: '8px'
              }}>
                <div style={{
                  fontSize: '14px',
                  color: currentTheme.text,
                  fontWeight: '500'
                }}>
                  Â© {new Date().getFullYear()} Datta Studio. All rights reserved.
                </div>
                <div style={{
                  display: 'flex',
                  flexWrap: 'wrap',
                  gap: isMobile ? '16px' : '28px',
                  fontSize: '13px',
                  color: currentTheme.textSecondary,
                  alignItems: 'center'
                }}>
                  <span style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    padding: '6px 12px',
                    backgroundColor: isDarkMode ? 'rgba(16, 185, 129, 0.1)' : 'rgba(16, 185, 129, 0.08)',
                    borderRadius: '20px',
                    border: `1px solid ${isDarkMode ? 'rgba(16, 185, 129, 0.3)' : 'rgba(16, 185, 129, 0.2)'}`
                  }}>
                    <span style={{
                      width: '10px',
                      height: '10px',
                      borderRadius: '50%',
                      backgroundColor: '#10b981',
                      display: 'inline-block',
                      animation: 'pulse 2s infinite',
                      boxShadow: '0 0 8px rgba(16, 185, 129, 0.6)'
                    }}></span>
                    <style>{`
                      @keyframes pulse {
                        0%, 100% { opacity: 1; transform: scale(1); }
                        50% { opacity: 0.7; transform: scale(1.1); }
                      }
                    `}</style>
                    <span style={{ 
                      color: '#10b981',
                      fontWeight: '500',
                      fontSize: '13px'
                    }}>All systems operational</span>
                  </span>
                  <span style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    padding: '6px 12px',
                    backgroundColor: isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.08)',
                    borderRadius: '20px',
                    border: `1px solid ${isDarkMode ? 'rgba(239, 68, 68, 0.3)' : 'rgba(239, 68, 68, 0.2)'}`
                  }}>
                    Made with <span style={{ 
                      color: '#ef4444',
                      fontSize: '16px',
                      animation: 'heartbeat 1.5s infinite'
                    }}>â™¥</span>
                    <style>{`
                      @keyframes heartbeat {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.2); }
                      }
                    `}</style>
                    <span style={{ 
                      color: currentTheme.textSecondary,
                      marginLeft: '4px'
                    }}>for AI</span>
                  </span>
                </div>
              </div>
            </div>
          </footer>
        )}

      </div>

      {/* New Add Data Source Modal */}
      <AddDataSourceModal
        isOpen={showNewAddSourceModal}
        isDarkMode={isDarkMode}
        onClose={() => setShowNewAddSourceModal(false)}
        onDatasetAdded={handleNewDatasetAdded}
      />

      {/* Repository List Modal - for OAuth repo selection */}
      {showRepoList && oauthProvider && oauthRepos.length > 0 && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          zIndex: 1001,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '20px'
        }}>
          <div style={{
            backgroundColor: isDarkMode ? '#1e293b' : 'white',
            borderRadius: '16px',
            width: '90%',
            maxWidth: '1000px',
            maxHeight: '80vh',
            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden'
          }}>
            {/* Header */}
            <div style={{
              padding: '24px',
              borderBottom: `1px solid ${isDarkMode ? '#334155' : '#e5e7eb'}`,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between'
            }}>
              <div>
                <h2 style={{
                  fontSize: '24px',
                  fontWeight: '700',
                  color: isDarkMode ? '#f1f5f9' : '#1e293b',
                  margin: '0 0 4px 0',
                  textTransform: 'capitalize'
                }}>
                  {oauthProvider} Repositories
                </h2>
                <p style={{
                  fontSize: '14px',
                  color: isDarkMode ? '#94a3b8' : '#64748b',
                  margin: 0
                }}>
                  {oauthUser?.name || oauthUser?.login || oauthUser?.username || 'Connected Account'}
                </p>
              </div>
              <button
                onClick={() => {
                  setShowRepoList(false);
                  setOAuthRepos([]);
                  setOAuthProvider(null);
                  setOAuthUser(null);
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '24px',
                  cursor: 'pointer',
                  color: isDarkMode ? '#94a3b8' : '#64748b',
                  padding: '4px',
                  borderRadius: '4px',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  (e.currentTarget as HTMLButtonElement).style.backgroundColor = isDarkMode ? '#334155' : '#f1f5f9';
                  (e.currentTarget as HTMLButtonElement).style.color = isDarkMode ? '#f1f5f9' : '#1e293b';
                }}
                onMouseLeave={(e) => {
                  (e.currentTarget as HTMLButtonElement).style.backgroundColor = 'transparent';
                  (e.currentTarget as HTMLButtonElement).style.color = isDarkMode ? '#94a3b8' : '#64748b';
                }}
              >
                âœ•
              </button>
            </div>

            {/* Repository List */}
            <div style={{ flex: 1, overflow: 'auto', padding: '24px' }}>
              <RepositoryList
                repos={oauthRepos}
                provider={oauthProvider as 'github' | 'gitlab'}
                isDarkMode={isDarkMode}
                onSelectRepo={() => {}} // Single select handler (not used in our flow)
                onSelectMultiple={handleRepositorySelect}
                isLoading={isStoringConnection}
              />
            </div>
          </div>
        </div>
      )}

      {/* Legacy Modal - kept for backward compatibility */}
      <SourcePickerModal
        open={showAddSourceModal && !showNewAddSourceModal}
        onClose={() => setShowAddSourceModal(false)}
      />

      {/* Data Wallet Modal */}
      <DataWallet
        isOpen={showDataWallet}
        onClose={() => setShowDataWallet(false)}
        isDarkMode={isDarkMode}
        initialFolder={selectedWalletFolder}
        uploadedFiles={uploadedFiles as any as WalletFile[]}
        userId={auth.currentUser?.uid || currentUser?.uid}
      />

      {/* License Selection Modal for OAuth and File Upload */}
      <LicenseSelectionModal
        isOpen={showLicenseSelectionModal}
        isDarkMode={isDarkMode}
        onClose={() => {
          setShowLicenseSelectionModal(false);
          setPendingOAuthProvider(null);
          setPendingFileUpload(false);
        }}
        onLicenseSelected={(licenseType) => {
          if (pendingOAuthProvider) {
            handleOAuthWithLicense(pendingOAuthProvider, licenseType);
          } else if (pendingFileUpload) {
            proceedWithFileUpload(licenseType);
          }
        }}
        sourceProvider={pendingOAuthProvider || undefined}
        onOAuthConnect={(provider, licenseType) => {
          handleOAuthWithLicense(provider, licenseType);
        }}
      />

      {/* Dataset Description Modal */}
      {showDescriptionModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          zIndex: 2000,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }}>
          <div style={{
            backgroundColor: isDarkMode ? '#1e293b' : 'white',
            borderRadius: '12px',
            padding: '32px',
            maxWidth: '500px',
            width: '90%',
            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)'
          }}>
            <h2 style={{
              margin: '0 0 8px 0',
              fontSize: '24px',
              fontWeight: '700',
              color: isDarkMode ? '#f1f5f9' : '#1e293b'
            }}>
              Describe Your Dataset
            </h2>
            <p style={{
              margin: '0 0 24px 0',
              fontSize: '14px',
              color: isDarkMode ? '#94a3b8' : '#64748b'
            }}>
              {pendingDatasetUpload?.file?.name}
            </p>
            
            <textarea
              value={datasetDescription}
              onChange={(e) => setDatasetDescription(e.target.value)}
              placeholder="Enter a clear description of your dataset (e.g., 'Open source Python projects from 2023', 'Modern art images for training')"
              style={{
                width: '100%',
                minHeight: '120px',
                padding: '12px',
                borderRadius: '8px',
                border: `1px solid ${isDarkMode ? '#334155' : '#e5e7eb'}`,
                backgroundColor: isDarkMode ? '#0f172a' : '#f8fafc',
                color: isDarkMode ? '#f1f5f9' : '#1e293b',
                fontSize: '14px',
                fontFamily: 'inherit',
                resize: 'vertical',
                boxSizing: 'border-box'
              }}
            />
            
            <p style={{
              margin: '12px 0 0 0',
              fontSize: '12px',
              color: isDarkMode ? '#64748b' : '#94a3b8'
            }}>
              {datasetDescription.length} characters
            </p>

            <div style={{
              display: 'flex',
              gap: '12px',
              marginTop: '24px',
              justifyContent: 'flex-end'
            }}>
              <button
                onClick={() => {
                  setShowDescriptionModal(false);
                  setPendingDatasetUpload(null);
                  setDatasetDescription('');
                }}
                disabled={isUploadingDataset}
                style={{
                  padding: '10px 20px',
                  backgroundColor: isDarkMode ? '#334155' : '#e5e7eb',
                  color: isDarkMode ? '#f1f5f9' : '#1e293b',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: isUploadingDataset ? 'not-allowed' : 'pointer',
                  opacity: isUploadingDataset ? 0.5 : 1,
                  transition: 'all 0.2s'
                }}
              >
                Cancel
              </button>
              <button
                onClick={handleDatasetDescriptionSubmit}
                disabled={isUploadingDataset}
                style={{
                  padding: '10px 20px',
                  backgroundColor: isUploadingDataset ? '#94a3b8' : '#06b6d4',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: isUploadingDataset ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  opacity: isUploadingDataset ? 0.7 : 1,
                  transition: 'all 0.2s'
                }}
              >
                {isUploadingDataset && (
                  <Loader style={{ 
                    width: '16px', 
                    height: '16px',
                    animation: 'spin 1s linear infinite'
                  }} />
                )}
                {isUploadingDataset ? 'Uploading...' : 'Upload Dataset'}
              </button>
            </div>
          </div>
        </div>
      )}

        </>
      )}

      {/* Profile Modal */}
      <ProfileModal open={showProfileModal} onClose={() => setShowProfileModal(false)} />
    </div>
  );
};

export default EnhancedDashboard;